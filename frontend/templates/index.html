<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMPASS | Intelligent Inference Engine</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #050505;
            --bg-sidebar: #0a0a0a;
            --bg-card: #121212;
            --bg-header: rgba(10, 10, 10, 0.8);
            --border: #27272a;
            --primary: #6366f1;
            /* Indigo-500 */
            --primary-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.2);
            --warning: #f59e0b;
            --danger: #ef4444;
            --case: #f59e0b;
            --control: #38bdf8;
            --verdict_ok: #60a5fa;
            --verdict_ok_glow: rgba(96, 165, 250, 0.22);
            --verdict_bad: #f59e0b;
            --verdict_bad_glow: rgba(245, 158, 11, 0.20);
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* HEADER */
        header {
            background: var(--bg-header);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            position: relative;
            z-index: 50;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .brand span {
            opacity: 0.6;
            font-weight: 400;
        }

        /* RADAR SPINNER */
        .radar-spinner {
            width: 60px;
            height: 60px;
            position: relative;
            margin: 2rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .radar-ripple {
            position: absolute;
            border: 2px solid var(--primary);
            opacity: 0;
            border-radius: 50%;
            animation: ripple 2s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }

        .radar-ripple:nth-child(2) {
            animation-delay: -0.5s;
        }

        .radar-core {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--primary);
        }

        @keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 100%;
                height: 100%;
                opacity: 0;
            }
        }

        .waiting-status {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 1rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* PIPELINE STEPPER */
        .stepper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .stepper-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #52525b;
            transition: all 0.3s ease;
        }

        .stepper-item.active {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .stepper-item.completed {
            color: var(--success);
        }

        .stepper-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .stepper-line {
            width: 14px;
            height: 1px;
            background: #27272a;
        }

        /* LAYOUT */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .main-panel {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            position: relative;
            background: radial-gradient(circle at top right, #1a1a2e 0%, transparent 40%);
        }

        .log-panel {
            width: 380px;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .log-header {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            line-height: 1.5;
            background: #080808;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Removed Memory MB */
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.2rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card:hover {
            border-color: #404040;
            transform: translateY(-2px);
        }

        .stat-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0.1;
            font-size: 2rem;
        }

        .stat-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: var(--font-mono);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* TIMELINE & TABS */
        .timeline-wrapper {
            background: #09090b;
            /* Zinc-950 */
            border: 1px solid #27272a;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 500px;
            /* Taller default */
        }

        .timeline-tabs {
            display: flex;
            background: #121212;
            border-bottom: 1px solid #27272a;
            padding: 4px;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #71717a;
            /* Zinc-500 */
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: var(--font-main);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .tab-btn:hover {
            color: #e4e4e7;
            background: rgba(255, 255, 255, 0.03);
        }

        .tab-btn.active {
            color: #fff;
            background: #27272a;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .tab-btn i {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .tab-btn.active i {
            color: var(--primary);
            opacity: 1;
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
            flex: 1;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            position: relative;
            background: #09090b;
        }

        .tab-content.active {
            display: block;
        }

        /* RESULTS VIEW STYLING */
        .results-container {
            display: flex;
            height: 600px;
            /* Fixed height for scrolling */
            border-top: 1px solid #27272a;
        }

        .file-list-pane {
            width: 280px;
            background: #0c0c0e;
            border-right: 1px solid #27272a;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .file-list-header {
            padding: 12px 16px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #52525b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #27272a;
            background: #121212;
            position: sticky;
            top: 0;
        }

        .file-item {
            padding: 12px 16px;
            font-size: 0.85rem;
            color: #a1a1aa;
            border-bottom: 1px solid #18181b;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #18181b;
            color: #fff;
            padding-left: 20px;
        }

        .file-item.active {
            background: #1d1d20;
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .file-preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #050505;
            overflow: hidden;
        }

        .preview-header {
            padding: 10px 20px;
            border-bottom: 1px solid #27272a;
            background: #09090b;
            color: #d4d4d8;
            font-size: 0.85rem;
            font-family: var(--font-mono);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-content-view {
            flex: 1;
            padding: 1.5rem;

            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #d4d4d8;

            overflow-y: auto;
            white-space: pre-wrap;
        }

        .file-content-view.markdown-render {
            font-family: var(--font-main);
            font-size: 0.92rem;
            line-height: 1.7;
            color: #e4e4e7;
            white-space: normal;
        }

        .file-content-view.markdown-render h1,
        .file-content-view.markdown-render h2,
        .file-content-view.markdown-render h3,
        .file-content-view.markdown-render h4 {
            margin: 1.2rem 0 0.6rem;
            font-weight: 700;
            color: #f4f4f5;
        }

        .file-content-view.markdown-render p {
            margin: 0.5rem 0;
        }

        .file-content-view.markdown-render ul,
        .file-content-view.markdown-render ol {
            margin: 0.6rem 0 0.6rem 1.25rem;
        }

        .file-content-view.markdown-render li {
            margin: 0.25rem 0;
        }

        .file-content-view.markdown-render table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .file-content-view.markdown-render th,
        .file-content-view.markdown-render td {
            border: 1px solid #27272a;
            padding: 0.5rem 0.6rem;
            text-align: left;
        }

        .file-content-view.markdown-render th {
            background: #0f0f12;
            color: #fafafa;
        }

        .file-content-view.markdown-render code {
            background: #111113;
            padding: 0.1rem 0.35rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .file-content-view.markdown-render pre {
            background: #0b0b0d;
            border: 1px solid #27272a;
            padding: 0.75rem 0.9rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.8rem 0;
        }

        /* INSPECTOR */
        #inspector-content {
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #52525b;
        }

        /* STEPS */
        .step-list {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .step {
            display: flex;
            gap: 1rem;
            opacity: 0.6;
            transition: all 0.4s ease;
        }

        .step.active {
            opacity: 1;
            transform: scale(1.01);
        }

        .step.active .step-card {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.1);
        }

        .step.failed .step-card {
            border-color: var(--danger);
        }

        .step-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 24px;
        }

        .step-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border);
            transition: all 0.3s;
            margin-top: 1.2rem;
        }

        .step.active .step-circle {
            border-color: var(--primary);
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .step.complete .step-circle {
            border-color: var(--success);
            background: var(--success);
        }

        .step-rail {
            flex: 1;
            width: 2px;
            background: var(--border);
            margin: 0.5rem 0;
            opacity: 0.5;
        }

        .step-card {
            flex: 1;
            background: #18181b;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .step-tool {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-tool i {
            color: var(--primary);
            font-size: 0.8rem;
        }

        .step-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .step-meta {
            font-size: 0.75rem;
            color: #52525b;
            font-family: var(--font-mono);
            background: #000;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #27272a;
        }

        .step-preview {
            margin-top: 0.8rem;
            padding: 0.8rem;
            background: #0a0a0a;
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            border-left: 2px solid var(--primary);
            color: #d4d4d8;
            white-space: pre-wrap;
            /* Preserve formatting */
        }

        /* OVERLAYS & MODALS */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .glass-panel {
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 2.5rem;
            width: 520px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: translateY(30px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .glass-panel {
            transform: translateY(0);
        }

        .launch-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
            text-align: center;
            display: block;
        }

        .form-label {
            display: block;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: #050505;
            border: 1px solid #333;
            padding: 0.9rem;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            margin-bottom: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .btn-launch {
            width: 100%;
            background: var(--primary);
            border: none;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.8rem;
        }

        .btn-launch:hover {
            background: #4f46e5;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: #27272a;
            color: #fff;
            margin-top: 1rem;
        }

        .btn-secondary:hover {
            background: #3f3f46;
        }

        /* WIZARD */
        .wizard-step {
            display: none;
            animation: fadeIn 0.3s;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-progress {
            display: flex;
            gap: 5px;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .wizard-dot {
            width: 40px;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        .wizard-dot.active {
            background: var(--primary);
        }

        /* UTILS */
        .log-entry {
            margin-bottom: 6px;
            padding-left: 12px;
            border-left: 2px solid #333;
            animation: fadeIn 0.2s;
        }

        .log-ts {
            color: #52525b;
            font-size: 0.7em;
            margin-right: 8px;
            user-select: none;
        }

        .log-type {
            font-weight: bold;
            font-size: 0.75em;
            display: inline-block;
            width: 55px;
        }

        .type-INFO {
            color: var(--primary);
        }

        .type-SUCCESS {
            color: var(--success);
        }

        .type-WARNING {
            color: var(--warning);
        }

        .type-ERROR {
            color: var(--danger);
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* VERDICT PANEL */
        .prediction-hero {
            background: #0d0d12;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .verdict-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }

        .verdict-card {
            background: #121218;
            border: 1px solid #27272a;
            border-radius: 10px;
            padding: 1rem 1.1rem;
        }

        .verdict-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .verdict-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
        }

        .verdict-sub {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .verdict-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid #333;
            color: #d4d4d8;
            background: #0b0b10;
        }

        .verdict-badge.good {
            border-color: var(--verdict_ok);
            color: var(--verdict_ok);
            box-shadow: 0 0 12px var(--verdict_ok_glow);
        }

        .verdict-badge.bad {
            border-color: var(--verdict_bad);
            color: var(--verdict_bad);
            box-shadow: 0 0 12px var(--verdict_bad_glow);
        }

        .verdict-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 0.6rem;
        }

        .check-pill {
            font-size: 0.65rem;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid #333;
            color: #a1a1aa;
            background: #0a0a0c;
        }

        .check-pill.pass {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.08);
        }

        .check-pill.fail {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(239, 68, 68, 0.08);
        }

        .verdict-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        /* CRITIC TOAST */
        .critic-toast {
            position: fixed;
            top: 74px;
            right: 20px;
            width: 380px;
            background: #0f0f13;
            border: 1px solid #2f2f37;
            border-left: 4px solid var(--verdict_bad);
            border-radius: 12px;
            padding: 1rem 1.1rem;
            z-index: 1100;
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.45);
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .critic-toast.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #fcd34d;
        }

        .toast-close {
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            font-size: 1rem;
        }

        .toast-body {
            font-size: 0.8rem;
            color: #d4d4d8;
            line-height: 1.5;
        }

        .toast-meta {
            margin-top: 0.6rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.7rem;
            color: #a1a1aa;
        }

        #global-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            transition: width 0.4s ease;
            width: 0%;
        }
    </style>
</head>

<body>

    <!-- SETUP MODAL (WIZARD) -->
    <div id="setup-modal" class="modal-overlay active">
        <div class="glass-panel">

            <!-- STEP 1: Mission Data (Only Step) -->
            <div id="wiz-1" class="wizard-step active">
                <i class="fas fa-satellite-dish launch-icon"></i>
                <h2 style="font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Mission Data</h2>
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label">PARTICIPANT IDENTIFIER (or path)</label>
                    <input type="text" id="input-pid" class="form-input"
                        placeholder="e.g. participant_ID6015951 or 6015951" value="">
                </div>

                <div>
                    <label class="form-label">TARGET PHENOTYPE</label>
                    <input type="text" id="input-target" class="form-input" placeholder="e.g. neuropsychiatric"
                        value="neuropsychiatric">
                </div>

                <!-- ADVANCED SETTINGS TOGGLE -->
                <div style="margin-bottom: 1.5rem;">
                    <button onclick="toggleAdvanced()"
                        style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer;">
                        <i id="adv-caret" class="fas fa-caret-right"></i> Advanced Configuration
                    </button>
                    <div id="advanced-opts"
                        style="display:none; margin-top:10px; padding:10px; background:#18181b; border-radius:8px;">
                        <div style="margin-bottom:10px;">
                            <label class="form-label">LLM Backend</label>
                            <select id="input-backend" class="form-input" onchange="toggleModelInput()"
                                style="padding:0.6rem;">
                                <option value="openai" selected>GPT-5 (default)</option>
                                <option value="local">Local (vLLM/Ollama)</option>
                            </select>
                        </div>

                        <div id="group-model"
                            style="display:none; margin-bottom:10px; border-left: 2px solid var(--primary); padding-left:10px;">
                            <label class="form-label">Local Model Path/Name</label>
                            <input type="text" id="input-model" class="form-input" placeholder="e.g. Qwen/Qwen2.5-7B"
                                value="Qwen/Qwen2.5-0.5B-Instruct">
                            <label class="form-label" style="margin-top:5px;">Max Context Tokens</label>
                            <input type="number" id="input-max-tokens" class="form-input" placeholder="2048"
                                value="2048">
                        </div>

                        <label class="form-label">Total Token Budget</label>
                        <input type="number" id="input-budget" class="form-input" placeholder="Default: 1500000"
                            style="padding:0.6rem;">

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label class="form-label">Max Agent Input</label>
                                <input type="number" id="input-max-agent" class="form-input" placeholder="20000"
                                    style="padding:0.6rem;">
                            </div>
                            <div>
                                <label class="form-label">Max Tool Output</label>
                                <input type="number" id="input-max-tool" class="form-input" placeholder="15000"
                                    style="padding:0.6rem;">
                            </div>
                        </div>

                        <!-- NEW: GRANULAR CONTROLS -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                            <div>
                                <label class="form-label">Max Agent Output</label>
                                <input type="number" id="input-max-agent-output" class="form-input" placeholder="4096"
                                    style="padding:0.6rem;">
                            </div>
                            <div>
                                <label class="form-label">Max Tool Input</label>
                                <input type="number" id="input-max-tool-input" class="form-input" placeholder="20000"
                                    style="padding:0.6rem;">
                            </div>
                        </div>
                    </div>
                </div>

                <button id="btn-final-launch" class="btn-launch" onclick="launchPipeline()">
                    <span>Launch Pipeline</span>
                    <i class="fas fa-rocket"></i>
                </button>
            </div>

        </div>
    </div>

    <!-- RESULT MODAL (DE-BRIEF) -->
    <div id="result-modal" class="modal-overlay">
        <div class="glass-panel" id="result-panel" style="text-align:center; border: 1px solid var(--verdict_ok);">
            <i class="fas fa-check-circle" id="result-icon"
                style="font-size: 4rem; color: var(--verdict_ok); margin-bottom: 1rem;"></i>
            <h2 style="margin-bottom:0.5rem;">MISSION DE-BRIEF</h2>
            <div id="final-verdict" class="verdict-badge" style="margin: 0.6rem auto 1rem auto;">Pending</div>
            <div
                style="display:flex; justify-content:center; gap:12px; font-size:0.8rem; color:#a1a1aa; margin-bottom:1rem;">
                <span>Probability: <strong id="final-probability" style="color:#fff;">--</strong></span>
                <span>Iterations: <strong id="final-iterations" style="color:#fff;">--</strong></span>
            </div>
            <div id="final-summary"
                style="background:#18181b; padding:1.5rem; border-radius:8px; margin:1.5rem 0; font-family:var(--font-mono); font-size:0.9rem; line-height:1.6; text-align:left; border-left:4px solid var(--verdict_ok);">
                Computing final summary...
            </div>
            <div id="final-checklist" class="verdict-checklist" style="justify-content:center; margin-bottom:1rem;">
            </div>
            <button class="btn-launch" onclick="closeResultModal()" style="background:var(--primary);">
                Review Mission Data
            </button>
        </div>
    </div>

    <!-- CRITIC UNSATISFACTORY TOAST -->
    <div id="critic-toast" class="critic-toast">
        <div class="toast-header">
            <div class="toast-title">Critic: UNSATISFACTORY</div>
            <button class="toast-close" onclick="dismissCriticToast()"><i class="fas fa-times"></i></button>
        </div>
        <div id="critic-toast-body" class="toast-body">Awaiting critic feedback...</div>
        <div id="critic-toast-meta" class="toast-meta"></div>
    </div>

    <!-- MAIN HEADER -->
    <header>
        <div class="brand">
            <i class="fas fa-compass"></i>
            COMPASS <span>DASHBOARD</span>
        </div>

        <div class="stepper" id="stepper">
            <div class="stepper-item">Initializing...</div>
        </div>

        <div style="font-size: 0.75rem; color: var(--text-muted); display:flex; align-items:center; gap:0.5rem;">
            <i class="fas fa-circle" id="status-dot" style="font-size: 6px; color: var(--success);"></i>
            <span id="session-status">System Ready</span>
        </div>

        <div id="global-progress"></div>
    </header>

    <div class="container">
        <!-- MAIN PANEL -->
        <main class="main-panel" id="main-scroller">

            <!-- STATS CARDS -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-title">Elapsed Time</div>
                    <div class="stat-value" id="timer">00:00</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-coins stat-icon"></i>
                    <div class="stat-title">Token Usage</div>
                    <div class="stat-value" id="token-display">0</div>
                </div>
                <!-- REMOVED MEMORY CARD -->
                <div class="stat-card">
                    <i class="fas fa-layer-group stat-icon"></i>
                    <div class="stat-title">Iteration</div>
                    <div class="stat-value"><span id="iter-display">1</span></div>
                </div>
            </div>

            <!-- TIMELINE & TABS -->
            <div class="timeline-wrapper">
                <div class="timeline-tabs" style="display:flex; align-items:center;">
                    <button class="tab-btn active" data-tab="timeline" onclick="switchTab('timeline', this)"><i class="fas fa-stream"></i> Live
                        Execution</button>
                    <button class="tab-btn" data-tab="plan" onclick="switchTab('plan', this);"><i class="fas fa-sitemap"></i> Execution
                        Plan</button>
                    <button class="tab-btn" data-tab="results" onclick="switchTab('results', this); loadResults();"><i
                            class="fas fa-file-alt"></i> Results</button>
                    <button class="tab-btn" data-tab="inspector" onclick="switchTab('inspector', this); loadInputs();"><i class="fas fa-code"></i>
                        Data Inspector</button>
                    <button onclick="toggleTimelineScroll()" id="btn-timeline-scroll"
                        style="margin-left:auto; background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.7rem; font-weight:600; padding:0 10px;">AUTO-FOLLOW:
                        ON</button>
                </div>

                <!-- TAB: TIMELINE -->
                <div id="tab-timeline" class="tab-content active" style="padding:0;">
                    <div class="step-list" id="steps-container">
                        <div style="text-align:center; padding: 4rem; color: var(--text-muted); opacity: 0.5;">
                            <i class="fas fa-satellite-dish" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Pipeline is ready. Launching mission...</p>
                        </div>
                    </div>
                </div>

                <!-- TAB: EXECUTION PLAN -->
                <div id="tab-plan" class="tab-content">
                    <div class="results-container">
                        <div class="file-list-pane" style="width:150px;">
                            <div class="file-list-header">Iterations</div>
                            <div id="plan-iter-list">
                                <!-- JS Injected -->
                            </div>
                        </div>
                        <div class="file-preview-pane" id="plan-detail-view" style="padding:1.5rem; overflow-y:auto;">
                            <div style="text-align:center; color:#555; margin-top:3rem;">Waiting for Orchestrator...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RESULTS TAB -->
                <div id="tab-results" class="tab-content" style="padding:0;">
                    <div class="results-container">
                        <div class="file-list-pane">
                            <div class="file-list-header">Generated Artifacts</div>
                            <div id="file-list-container">
                                <!-- JS injected -->
                                <div style="padding:1rem; color:#444; font-style:italic;">No files yet...</div>
                            </div>
                        </div>
                        <div class="file-preview-pane">
                            <div class="preview-header">
                                <span id="current-file-name">Preview</span>
                                <span style="opacity:0.5; font-size:0.75rem;">READ-ONLY</span>
                            </div>
                            <div id="file-preview-container" class="file-content-view">
                                <div style="color: #333; text-align: center; margin-top: 4rem;">
                                    <i class="fas fa-file-alt"
                                        style="font-size:2rem; margin-bottom:1rem; opacity:0.3;"></i>
                                    <p>Select a file from the list to inspect contents.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: INSPECTOR -->
                <div id="tab-inspector" class="tab-content" style="padding:0;">
                    <div class="results-container">
                        <div class="file-list-pane">
                            <div class="file-list-header">Input Data Files</div>
                            <div id="input-list-container">
                                <div style="padding:1rem; color:#444; font-style:italic;">Loading...</div>
                            </div>
                        </div>
                        <div class="file-preview-pane">
                            <div class="preview-header">
                                <span id="current-input-name">Preview</span>
                                <span style="opacity:0.5; font-size:0.75rem;">READ-ONLY</span>
                            </div>
                            <div id="input-preview-container" class="file-content-view">
                                <div style="color: #333; text-align: center; margin-top: 4rem;">
                                    <i class="fas fa-database"
                                        style="font-size:2rem; margin-bottom:1rem; opacity:0.3;"></i>
                                    <p>Select an input file to inspect source data.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PREDICTION HERO -->
            <div id="prediction-hero" class="prediction-hero" style="display:none;">
                <div class="verdict-grid">
                    <div class="verdict-card">
                        <div class="verdict-title">Prediction Output</div>
                        <div class="verdict-value" id="prediction-label">--</div>
                        <div class="verdict-sub">Probability: <strong id="prediction-prob">--</strong></div>
                        <div class="verdict-sub">Confidence: <strong id="prediction-conf">--</strong></div>
                    </div>
                    <div class="verdict-card">
                        <div class="verdict-title">Critic Verdict</div>
                        <div class="verdict-value" id="critic-verdict">--</div>
                        <div class="verdict-sub" id="critic-summary">Awaiting critic evaluation...</div>
                        <div class="verdict-checklist" id="critic-checklist"></div>
                    </div>
                </div>
            <div class="verdict-actions">
                <button onclick="document.getElementById('result-modal').classList.add('active')"
                    style="background:none; border:1px solid var(--verdict_ok); color:var(--verdict_ok); padding:6px 12px; border-radius:4px; cursor:pointer;">
                    View De-brief
                </button>
            </div>
            </div>

        </main>

        <!-- SIDEBAR LOGS -->
        <aside class="log-panel" id="log-panel">
            <div class="log-header">
                <span><i class="fas fa-terminal" style="margin-right:8px;"></i> System Logs</span>
                <div style="display:flex; gap:10px;">
                    <i class="fas fa-sync-alt" id="activity-spinner" style="opacity:0;"></i>
                    <button onclick="toggleLogScroll()" id="btn-log-scroll"
                        style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.7rem; font-weight:600;">AUTO:
                        ON</button>
                </div>
            </div>
            <div class="log-content" id="log-container"></div>
        </aside>
    </div>

    <!-- LOGIC -->
    <script src="/static/marked.min.js"></script>
    <script>
        // State
        let latestEventId = 0;
        let isRunning = false;
        let autoScrollTimeline = true;
        let autoScrollLogs = true;
        let startTime = null;
        let currentIteration = 1;
        let hasShownResultModal = false;
        let uiSelectedPlanIter = null; // Track user selection for Plan view

        // WIZARD LOGIC
        function toggleModelInput() {
            const val = document.getElementById('input-backend').value;
            document.getElementById('group-model').style.display = val === 'local' ? 'block' : 'none';
        }

        function toggleAdvanced() {
            const el = document.getElementById('advanced-opts');
            const caret = document.getElementById('adv-caret');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                caret.classList.remove('fa-caret-right');
                caret.classList.add('fa-caret-down');
            } else {
                el.style.display = 'none';
                caret.classList.remove('fa-caret-down');
                caret.classList.add('fa-caret-right');
            }
        }

        async function launchPipeline() {
            const pid = document.getElementById('input-pid').value;
            const target = document.getElementById('input-target').value;

            // Advanced settings
            const budget = document.getElementById('input-budget').value;
            const maxAgent = document.getElementById('input-max-agent').value;
            const maxTool = document.getElementById('input-max-tool').value;

            // NEW: Granular controls
            const maxAgentOutput = document.getElementById('input-max-agent-output').value;
            const maxToolInput = document.getElementById('input-max-tool-input').value;

            const backend = document.getElementById('input-backend').value;
            const model = document.getElementById('input-model').value;
            const maxTokens = document.getElementById('input-max-tokens').value;

            if (!pid) return alert("Participant ID required");

            const btn = document.getElementById('btn-final-launch');
            btn.innerHTML = '<i class="fas fa-circle-notch spin"></i> Launching...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/launch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: pid, target: target,
                        total_budget: budget ? parseInt(budget) : null,
                        max_agent_input: maxAgent ? parseInt(maxAgent) : null,
                        max_tool_output: maxTool ? parseInt(maxTool) : null,
                        max_agent_output: maxAgentOutput ? parseInt(maxAgentOutput) : null,
                        max_tool_input: maxToolInput ? parseInt(maxToolInput) : null,
                        backend: backend,
                        model: model,
                        max_tokens: maxTokens ? parseInt(maxTokens) : null
                    })
                });
                const data = await res.json();

                if (data.status === 'started') {
                    setTimeout(() => {
                        document.getElementById('setup-modal').classList.remove('active');
                        document.getElementById('session-status').textContent = "Pipeline Active";
                        document.getElementById('status-dot').classList.add('pulse');
                        isRunning = true;
                    }, 800);
                }
            } catch (e) {
                console.error(e);
                btn.innerHTML = 'Launch Failed';
                btn.disabled = false;
                alert("Connection failed.");
            }
        }

        function toggleLogScroll() {
            autoScrollLogs = !autoScrollLogs;
            document.getElementById('btn-log-scroll').textContent = autoScrollLogs ? 'AUTO: ON' : 'AUTO: OFF';
        }

        function toggleTimelineScroll() {
            autoScrollTimeline = !autoScrollTimeline;
            const btn = document.getElementById('btn-timeline-scroll');
            btn.textContent = autoScrollTimeline ? 'AUTO-FOLLOW: ON' : 'AUTO-FOLLOW: OFF';
            btn.style.opacity = autoScrollTimeline ? '1' : '0.5';
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            const targetBtn = btn || document.querySelector(`.tab-btn[data-tab="${tab}"]`) || (typeof event !== 'undefined' ? event.target : null);
            if (targetBtn) targetBtn.classList.add('active');
        }

        async function closeResultModal() {
            document.getElementById('result-modal').classList.remove('active');
            switchTab('results');
            await loadResults();
            await openStandardReport();
        }

        function dismissCriticToast() {
            const toast = document.getElementById('critic-toast');
            toast.classList.remove('active');
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/\'/g, "&#039;");
        }

        function normalizeClassification(raw) {
            if (!raw) return 'UNKNOWN';
            const upper = String(raw).toUpperCase();
            if (upper.includes('CONTROL')) return 'CONTROL';
            if (upper.includes('CASE')) return 'CASE';
            return String(raw).trim();
        }

        const CHECKLIST_LABELS = {
            has_binary_outcome: "Binary outcome",
            valid_probability: "Valid probability",
            sufficient_coverage: "Coverage",
            evidence_based_reasoning: "Evidence-based",
            clinically_relevant: "Clinical relevance",
            logically_coherent: "Coherence",
            critical_domains_processed: "Critical domains"
        };

        function buildChecklistPills(checklist, compact = true) {
            if (!checklist) return '';
            const entries = Object.keys(CHECKLIST_LABELS).map(key => ({
                key,
                label: CHECKLIST_LABELS[key],
                pass: Boolean(checklist[key])
            }));
            const passCount = entries.filter(e => e.pass).length;
            const total = entries.length || 7;
            const failed = entries.filter(e => !e.pass);

            let pills = `<span class="check-pill ${failed.length ? 'fail' : 'pass'}">${passCount}/${total} checks</span>`;
            const list = compact ? failed : entries;
            if (list.length === 0 && !compact) {
                return pills;
            }
            list.forEach(item => {
                const cls = item.pass ? 'pass' : 'fail';
                const label = item.pass ? ` ${item.label}` : ` ${item.label}`;
                pills += `<span class="check-pill ${cls}">${label}</span>`;
            });
            return pills;
        }

        function showCriticToast(criticData) {
            if (!criticData || criticData.verdict !== 'UNSATISFACTORY') return;
            const toast = document.getElementById('critic-toast');
            const title = toast.querySelector('.toast-title');
            const body = document.getElementById('critic-toast-body');
            const meta = document.getElementById('critic-toast-meta');

            title.textContent = `Critic: ${criticData.verdict}`;
            title.style.color = 'var(--verdict_bad)';

            const summary = criticData.summary || 'Critic found issues requiring re-orchestration.';
            const weaknesses = (criticData.weaknesses || []).slice(0, 2);
            const suggestions = (criticData.improvement_suggestions || []).slice(0, 1);

            const weaknessText = weaknesses.length ? `Key issues: ${escapeHtml(weaknesses.join(' | '))}` : '';
            let suggestionLabel = '';
            if (suggestions.length) {
                const sugg = suggestions[0];
                if (typeof sugg === 'string') {
                    suggestionLabel = sugg;
                } else {
                    suggestionLabel = sugg.issue || sugg.suggestion || '';
                }
            }
            const suggestionText = suggestionLabel ? `Fix: ${escapeHtml(suggestionLabel)}` : '';

            body.innerHTML = `
                <div>${escapeHtml(summary)}</div>
                ${weaknessText ? `<div style="margin-top:6px;">${weaknessText}</div>` : ''}
                ${suggestionText ? `<div style="margin-top:6px;">${suggestionText}</div>` : ''}
                <div style="margin-top:6px;">${buildChecklistPills(criticData.checklist, true)}</div>
            `;

            const metaItems = [];
            const lastState = window.__lastState || {};
            if (lastState.iteration && lastState.max_iterations) {
                metaItems.push(`Iteration: ${lastState.iteration}/${lastState.max_iterations}`);
            }
            if (typeof criticData.composite_score === 'number') {
                metaItems.push(`Score: ${criticData.composite_score.toFixed(2)}`);
            }
            if (typeof criticData.passed === 'number' && typeof criticData.total === 'number') {
                metaItems.push(`Checklist: ${criticData.passed}/${criticData.total}`);
            }
            metaItems.push('Re-orchestrating...');
            meta.innerHTML = metaItems.map(m => `<span>${escapeHtml(m)}</span>`).join('');

            toast.classList.add('active');
            clearTimeout(window.__criticToastTimer);
            window.__criticToastTimer = setTimeout(() => toast.classList.remove('active'), 6500);
        }

        function renderSteps(steps, currentStage) {
            const container = document.getElementById('steps-container');

            // Special state for Orchestration (Stage 1) waiting
            if ((!steps || steps.length === 0) && currentStage === 1) {
                container.innerHTML = `
                    <div class="radar-spinner">
                        <div class="radar-ripple"></div>
                        <div class="radar-ripple"></div>
                        <div class="radar-core"></div>
                    </div>
                    <div class="waiting-status">Orchestrator creating execution plan...</div>
                `;
                return;
            }

            // Generate Steps HTML
            let html = `
                <div class="step ${currentStage > 0 ? 'complete' : (currentStage === 0 ? 'active' : '')}" id="step-0-0">
                    <div class="step-marker">
                        <div class="step-circle"></div>
                        <div class="step-rail"></div>
                    </div>
                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-tool"><i class="fas fa-power-off"></i> Initialization</div>
                            <div class="step-meta">Step 0</div>
                        </div>
                        <div class="step-desc">Pipeline initialization, data loading, and agent setup.</div>
                    </div>
                </div>
            `;

            if (steps && steps.length > 0) {
                steps.forEach((step, index) => {
                    // Check for iteration change to inject separator
                    if (index > 0 && step.iteration > steps[index - 1].iteration) {
                        html += `
                            <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.8rem; opacity:0.7;">
                                <i class="fas fa-sync-alt"></i> RE-ORCHESTRATING (Iteration ${step.iteration})
                                <div style="height:1px; background:var(--border); margin:0.5rem 0;"></div>
                            </div>
                         `;
                    }

                    // Use unique ID prefix
                    const uid = step.iteration ? `${step.iteration}-${step.id}` : step.id;

                    html += `
                        <div class="step ${step.status} ${step.status === 'running' ? 'active' : ''}" id="step-${uid}">
                            <div class="step-marker">
                                <div class="step-circle"></div>
                                <div class="step-rail"></div>
                            </div>
                            <div class="step-card">
                                <div class="step-header">
                                    <div class="step-tool"><i class="fas fa-wrench"></i> ${step.tool}</div>
                                    <div class="step-meta">${step.duration ? step.duration + 's' : (step.status === 'running' ? 'running' : 'pending')}</div>
                                </div>
                                <div class="step-desc">${step.desc}</div>
                                ${step.preview ? `<div class="step-preview">${step.preview}</div>` : ''}
                                ${step.error ? `<div class="step-preview" style="border-color:var(--danger); color:#fca5a5;">${step.error}</div>` : ''}
                            </div>
                </div>
                    `;
                });

                // If re-orchestrating (Stage 1) but we have history, show a spinner at the bottom
                if (currentStage === 1) {
                    html += `
                       <div class="step active" id="orchestrating-spinner" style="opacity:0.8;">
                           <div class="step-marker">
                               <div class="step-circle" style="background:var(--primary); animation:pulse 1.5s infinite;"></div>
                               <div class="step-rail"></div>
                           </div>
                           <div class="step-card" style="border:1px dashed #444; background:rgba(20,20,25,0.5);">
                               <div class="step-header">
                                   <div class="step-tool" style="color:var(--primary);">Orchestrating Next Phase...</div>
                               </div>
                               <div class="step-desc">Analyzing feedback and generating new execution plan.</div>
                           </div>
                       </div>
                    `;
                }
            }
            container.innerHTML = html;
        }

        function renderPlan(plans, currentRunningIter) {
            const listContainer = document.getElementById('plan-iter-list');
            const detailContainer = document.getElementById('plan-detail-view');

            if (!plans || Object.keys(plans).length === 0) {
                detailContainer.innerHTML = '<div style="text-align:center; color:#555; margin-top:3rem;">No plan generated yet.</div>';
                return;
            }

            // Determine which iteration to show: User selection OR current running
            const iterToShow = uiSelectedPlanIter || currentRunningIter || Object.keys(plans)[0];

            // Render Tabs
            listContainer.innerHTML = Object.keys(plans).map(iter => `
                <div class="file-item ${iter == iterToShow ? 'active' : ''}" style="padding:10px 16px; cursor:pointer;" onclick="uiSelectedPlanIter='${iter}'; renderPlan(window.lastPlans, ${currentRunningIter})">
                    <span><i class="fas fa-project-diagram"></i> Iteration ${iter}</span>
                </div>
            `).join('');

            // Render Current Plan
            const plan = plans[iterToShow];
            if (plan) {
                const steps = plan.steps || [];

                // PLAN SUMMARY HEADER
                const userExpl = plan.user_facing_explanation || plan.fusion_strategy || "No summary provided.";

                const stepsHtml = steps.map(s => {
                    // Visual dependency indicator
                    const depNodes = (s.depends_on || []).map(d =>
                        `<span style="background:#333; padding:2px 6px; border-radius:4px; font-size:0.65rem; margin-right:4px;">step_${d}</span>`
                    ).join('');

                    return `
                    <div class="plan-node" style="background:#0e0e0e; border:1px solid #333; padding:12px; border-radius:6px; margin-bottom:10px; border-left: 3px solid var(--primary);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px; align-items:center;">
                             <span style="font-weight:700; color:#fff; font-size:0.95rem;">${s.step_id}. ${s.tool_name}</span>
                             <span style="font-size:0.75rem; color:#666; background:#111; padding:2px 6px; border-radius:4px;">${s.estimated_tokens} tokens</span>
                        </div>
                        <div style="color:#ccc; font-size:0.85rem; line-height:1.4; margin-bottom:8px;">${s.description}</div>
                        
                        <!-- Dependencies -->
                        <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:6px;">
                            ${depNodes ? depNodes : ''}
                        </div>
                        
                        <!-- Reasoning on new line to avoid overlap -->
                        ${s.reasoning ? `
                            <div style="margin-top:6px; padding-top:6px; border-top:1px solid #222; font-size:0.75rem; color:#666; font-style:italic;">
                                <i class="fas fa-lightbulb" style="margin-right:4px;"></i> ${s.reasoning}
                            </div>
                        ` : ''}
                    </div>
                 `}).join('');

                detailContainer.innerHTML = `
                    <div style="margin-bottom:1.5rem; background:#1f1f23; padding:1.5rem; border-radius:8px; border:1px solid #333;">
                        <div style="color:var(--primary); font-size:0.8rem; letter-spacing:1px; font-weight:700; margin-bottom:0.5rem;">EXECUTION STRATEGY</div>
                        <div style="font-size:1rem; color:#eee; line-height:1.6;">${userExpl}</div>
                        <div style="margin-top:1rem; display:flex; gap:15px; font-size:0.8rem; color:#888;">
                             <span><i class="fas fa-fingerprint"></i> Plan ID: ${plan.plan_id || 'N/A'}</span>
                             <span><i class="fas fa-layer-group"></i> ${steps.length} Steps</span>
                        </div>
                    </div>
                    <div class="plan-timeline">
                        ${stepsHtml}
                    </div>
                 `;
            } else {
                detailContainer.innerHTML = '<div style="text-align:center; color:#555; margin-top:3rem;">Plan data not available for this iteration.</div>';
            }
        }

        // POLLING LOOP
        async function updateLoop() {
            try {
                const res = await fetch(`/api/snapshot?since_id=${latestEventId}`);
                const data = await res.json();
                const state = data.state;
                window.__lastState = state;

                // Reset client-side session flags when a new pipeline run starts.
                const sessionKey = `${state.participant_id || ''}|${state.start_time || ''}`;
                if (window.__sessionKey && sessionKey !== window.__sessionKey) {
                    startTime = null;
                    hasShownResultModal = false;
                    currentIteration = state.iteration || 1;
                }
                window.__sessionKey = sessionKey;

                // Store plans globally for the click handler
                window.lastPlans = state.plans;

                // Stats
                document.getElementById('token-display').textContent = state.total_tokens.toLocaleString();
                document.getElementById('iter-display').textContent = state.iteration || 1;

                // Timer
                if (state.start_time && !startTime) startTime = new Date();
                if (startTime && !state.completed && state.status !== "Pipeline Completed") {
                    const diff = Math.floor((new Date() - startTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${m}:${s}`;
                }

                // Global Progress & Completion Check
                const maxIters = state.max_iterations || 1;
                const iterNow = state.iteration || 1;
                const criticIter = state.critic && state.critic.iteration ? state.critic.iteration : null;
                const isFinalCritic = state.critic && (
                    state.critic.verdict === 'SATISFACTORY' ||
                    (criticIter !== null ? criticIter >= maxIters : false)
                );

                if (state.completed || state.status === "Pipeline Completed" || state.status.includes("Mission Complete") || isFinalCritic) {
                    if (isRunning) {
                        isRunning = false;
                        document.getElementById('session-status').textContent = "Mission Complete";
                        document.getElementById('status-dot').classList.remove('pulse');
                        document.getElementById('global-progress').style.width = '100%';
                    }
                } else {
                    const pct = (state.progress / (state.max_steps || 1)) * 100;
                    document.getElementById('global-progress').style.width = `${Math.min(pct, 100)}%`;
                }

                // Stepper Header
                const stepper = document.getElementById('stepper');
                const curStage = state.current_stage || 0;
                if (state.stages) {
                    stepper.innerHTML = state.stages.map((st, i) => `
                        <div class="stepper-item ${i < curStage ? 'completed' : ''} ${i === curStage ? 'active' : ''}">
                            <div class="stepper-dot"></div>${st}
                        </div>
                        ${i < state.stages.length - 1 ? '<div class="stepper-line"></div>' : ''}
                    `).join('');
                }

                // Render Steps (Main Timeline) - WITH HISTORY
                const allSteps = (state.history || []).concat(state.steps);
                renderSteps(allSteps, state.current_stage);

                // Render Execution Plan tab
                if (state.plans) {
                    renderPlan(state.plans, state.iteration);
                }

                // Prediction + Critic Summary Panel
                if (state.prediction || state.critic) {
                    document.getElementById('prediction-hero').style.display = 'block';
                } else {
                    document.getElementById('prediction-hero').style.display = 'none';
                    document.getElementById('prediction-label').textContent = '--';
                    document.getElementById('prediction-prob').textContent = '--';
                    document.getElementById('prediction-conf').textContent = '--';
                    document.getElementById('critic-verdict').textContent = '--';
                    document.getElementById('critic-summary').textContent = 'Awaiting critic evaluation...';
                    document.getElementById('critic-checklist').innerHTML = '';
                }

                if (state.prediction) {
                    const label = state.prediction.label || normalizeClassification(state.prediction.result);
                    document.getElementById('prediction-label').textContent = label;
                    document.getElementById('prediction-prob').textContent = (state.prediction.prob * 100).toFixed(1) + "%";
                    document.getElementById('prediction-conf').textContent = state.prediction.confidence || '--';
                    document.getElementById('prediction-label').style.color = label === 'CASE' ? 'var(--case)' : (label === 'CONTROL' ? 'var(--control)' : 'var(--text-main)');
                }

                if (state.critic) {
                    const verdict = state.critic.verdict || '--';
                    document.getElementById('critic-verdict').textContent = verdict;
                    document.getElementById('critic-verdict').style.color = verdict === 'SATISFACTORY' ? 'var(--verdict_ok)' : 'var(--verdict_bad)';
                    document.getElementById('critic-summary').textContent = state.critic.summary || 'No critic summary provided.';
                    document.getElementById('critic-checklist').innerHTML = buildChecklistPills(state.critic.checklist, true);

                    const verdictBadge = document.getElementById('final-verdict');
                    verdictBadge.textContent = verdict;
                    verdictBadge.classList.remove('good', 'bad');
                    verdictBadge.classList.add(verdict === 'SATISFACTORY' ? 'good' : 'bad');

                    const statusDot = document.getElementById('status-dot');
                    statusDot.style.color = verdict === 'SATISFACTORY' ? 'var(--verdict_ok)' : 'var(--verdict_bad)';
                } else if (state.prediction) {
                    const label = state.prediction.label || normalizeClassification(state.prediction.result);
                    document.getElementById('status-dot').style.color = label === 'CASE' ? 'var(--case)' : (label === 'CONTROL' ? 'var(--control)' : 'var(--text-main)');
                }

                // Reset modal flag if iteration changes
                if (state.iteration && state.iteration > currentIteration) {
                    currentIteration = state.iteration;
                    hasShownResultModal = false;
                }

                // Result Modal (Mission De-brief)
                // Trigger when critic verdict is FINAL (SATISFACTORY or last iteration reached).
                if (state.critic && !hasShownResultModal && isFinalCritic) {
                    hasShownResultModal = true;
                    const summary = state.critic.summary || state.critic_summary || 'No critic summary provided.';
                    document.getElementById('final-summary').textContent = summary;
                    document.getElementById('final-probability').textContent = state.completion && state.completion.probability !== undefined
                        ? (state.completion.probability * 100).toFixed(1) + "%"
                        : (state.prediction ? (state.prediction.prob * 100).toFixed(1) + "%" : "--");
                    document.getElementById('final-iterations').textContent = state.completion && state.completion.iterations
                        ? state.completion.iterations
                        : (state.iteration || '--');
                    document.getElementById('final-checklist').innerHTML = buildChecklistPills(state.critic.checklist, false);

                    const resultPanel = document.getElementById('result-panel');
                    const resultIcon = document.getElementById('result-icon');
                    const summaryPanel = document.getElementById('final-summary');
                    if (state.critic.verdict === 'SATISFACTORY') {
                        resultPanel.style.borderColor = 'var(--verdict_ok)';
                        resultIcon.className = 'fas fa-check-circle';
                        resultIcon.style.color = 'var(--verdict_ok)';
                        summaryPanel.style.borderLeftColor = 'var(--verdict_ok)';
                    } else {
                        resultPanel.style.borderColor = 'var(--verdict_bad)';
                        resultIcon.className = 'fas fa-triangle-exclamation';
                        resultIcon.style.color = 'var(--verdict_bad)';
                        summaryPanel.style.borderLeftColor = 'var(--verdict_bad)';
                    }

                    document.getElementById('result-modal').classList.add('active');
                    document.getElementById('session-status').textContent = "Mission Complete";
                    document.getElementById('status-dot').classList.remove('pulse');
                    isRunning = false;
                }

                if (state.status === "Pipeline Completed") {
                    isRunning = false;
                    document.getElementById('status-dot').classList.remove('pulse');
                }

                // Logs
                if (data.events.length > 0) {
                    const logCon = document.getElementById('log-container');
                    document.getElementById('activity-spinner').style.opacity = 1;
                    setTimeout(() => document.getElementById('activity-spinner').style.opacity = 0, 500);

                    data.events.forEach(e => {
                        if (e.id <= latestEventId) return;
                        latestEventId = e.id;
                        const div = document.createElement('div');
                        div.className = 'log-entry';
                        div.innerHTML = `<span class="log-ts">${e.time}</span><span class="log-type type-${e.type}">${e.type}</span> <span>${JSON.stringify(e.data).substring(0, 100)}</span>`;
                        logCon.appendChild(div);

                        if (e.type === 'CRITIC' && e.data && e.data.verdict === 'UNSATISFACTORY') {
                            const finalIter = e.data.iteration !== undefined && e.data.iteration !== null
                                ? e.data.iteration
                                : (state.iteration || 1);
                            const isFinal = finalIter >= (state.max_iterations || 1);
                            if (isFinal) {
                                showCriticToast(e.data);
                            }
                        }
                    });
                    if (autoScrollLogs) logCon.scrollTop = logCon.scrollHeight;
                }

                // Auto scroll main timeline
                if (isRunning && autoScrollTimeline && state.steps.length > 0) {
                    // Only scroll if timeline tab is active
                    if (document.getElementById('tab-timeline').classList.contains('active')) {
                        const activeStep = document.querySelector('.step.active');
                        if (activeStep) {
                            activeStep.scrollIntoView({ behavior: "smooth", block: "nearest" });
                        }
                    }
                }

            } catch (err) { console.error(err); }
        }

        async function loadResults() {
            try {
                // Get participant ID from state or input
                // It is safer to ask API for output directory content
                const res = await fetch('/api/outputs');
                const files = await res.json();

                const container = document.getElementById('file-list-container');
                if (files.length === 0) {
                    container.innerHTML = '<div style="color:#666">No output files found.</div>';
                    return;
                }

                container.innerHTML = files.map(f => `
                    <div class="file-item" data-file="${f}" onclick="loadFile('${f}', this)">
                        <span><i class="fas fa-file-code"></i> ${f}</span>
                        <i class="fas fa-chevron-right" style="font-size:0.7rem; opacity:0.5;"></i>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        async function loadFile(filename, el) {
            document.querySelectorAll('#file-list-container .file-item').forEach(el => el.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                const match = document.querySelector(`.file-item[data-file="${filename}"]`);
                if (match) match.classList.add('active');
            }

            const preview = document.getElementById('file-preview-container');
            preview.classList.remove('markdown-render');
            document.getElementById('current-file-name').textContent = filename;
            preview.textContent = "Loading...";

            const res = await fetch(`/api/outputs/content?file=${filename}`);
            const text = await res.text();

            if (filename.endsWith('.md') && window.marked && typeof window.marked.parse === 'function') {
                preview.classList.add('markdown-render');
                preview.innerHTML = window.marked.parse(text);
            } else if (filename.endsWith('.md')) {
                preview.classList.add('markdown-render');
                preview.textContent = text;
            } else {
                preview.textContent = text;
            }
        }

        async function openStandardReport() {
            try {
                const state = window.__lastState || {};
                const pid = state.participant_id || '';
                if (!pid) return;
                const targetName = `report_${pid}.md`;
                const res = await fetch('/api/outputs');
                const files = await res.json();
                const file = files.find(f => f === targetName) || files.find(f => f.startsWith(`report_${pid}`) && f.endsWith('.md'));
                if (file) {
                    await loadFile(file);
                }
            } catch (e) { console.error(e); }
        }

        async function loadInputs() {
            try {
                const res = await fetch('/api/inputs');
                const files = await res.json();

                const container = document.getElementById('input-list-container');
                if (files.length === 0) {
                    container.innerHTML = '<div style="padding:1rem; color:#666">No input files found.</div>';
                    return;
                }

                container.innerHTML = files.map(f => `
                    <div class="file-item" data-file="${f}" onclick="loadInputFile('${f}', this)">
                        <span><i class="fas fa-table"></i> ${f}</span>
                        <i class="fas fa-chevron-right" style="font-size:0.7rem; opacity:0.5;"></i>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        async function loadInputFile(filename, el) {
            document.querySelectorAll('#input-list-container .file-item').forEach(el => el.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                const match = document.querySelector(`#input-list-container .file-item[data-file="${filename}"]`);
                if (match) match.classList.add('active');
            }

            document.getElementById('current-input-name').textContent = filename;
            document.getElementById('input-preview-container').textContent = "Loading...";

            const res = await fetch(`/api/inputs/content?file=${filename}`);
            const text = await res.text();
            document.getElementById('input-preview-container').textContent = text;
        }

        setInterval(updateLoop, 800);
    </script>
</body>

</html>
