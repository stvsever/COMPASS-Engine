<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMPASS | Intelligent Inference Engine</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #050505;
            --bg-sidebar: #0a0a0a;
            --bg-card: #121212;
            --bg-header: rgba(10, 10, 10, 0.8);
            --border: #27272a;
            --primary: #6366f1;
            /* Indigo-500 */
            --primary-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.2);
            --warning: #f59e0b;
            --danger: #ef4444;
            --case: #f59e0b;
            --control: #38bdf8;
            --verdict_ok: #60a5fa;
            --verdict_ok_glow: rgba(96, 165, 250, 0.22);
            --verdict_bad: #f59e0b;
            --verdict_bad_glow: rgba(245, 158, 11, 0.20);
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* HEADER */
        header {
            background: var(--bg-header);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            position: relative;
            z-index: 50;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .brand span {
            opacity: 0.6;
            font-weight: 400;
        }

        /* RADAR SPINNER */
        .radar-spinner {
            width: 60px;
            height: 60px;
            position: relative;
            margin: 2rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .radar-ripple {
            position: absolute;
            border: 2px solid var(--primary);
            opacity: 0;
            border-radius: 50%;
            animation: ripple 2s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }

        .radar-ripple:nth-child(2) {
            animation-delay: -0.5s;
        }

        .radar-core {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--primary);
        }

        @keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 100%;
                height: 100%;
                opacity: 0;
            }
        }

        .waiting-status {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 1rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* PIPELINE STEPPER */
        .stepper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .stepper-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #52525b;
            transition: all 0.3s ease;
        }

        .stepper-item.active {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .stepper-item.completed {
            color: var(--success);
        }

        .stepper-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .stepper-line {
            width: 14px;
            height: 1px;
            background: #27272a;
        }

        /* LAYOUT */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .main-panel {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            position: relative;
            background: radial-gradient(circle at top right, #1a1a2e 0%, transparent 40%);
        }

        .log-panel {
            width: 380px;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .log-header {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            line-height: 1.5;
            background: #080808;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Removed Memory MB */
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.2rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card:hover {
            border-color: #404040;
            transform: translateY(-2px);
        }

        .stat-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0.1;
            font-size: 2rem;
        }

        .stat-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: var(--font-mono);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* TIMELINE & TABS */
        .timeline-wrapper {
            background: #09090b;
            /* Zinc-950 */
            border: 1px solid #27272a;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 500px;
            /* Taller default */
        }

        .timeline-tabs {
            display: flex;
            background: #121212;
            border-bottom: 1px solid #27272a;
            padding: 4px;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #71717a;
            /* Zinc-500 */
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: var(--font-main);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .tab-btn:hover {
            color: #e4e4e7;
            background: rgba(255, 255, 255, 0.03);
        }

        .tab-btn.active {
            color: #fff;
            background: #27272a;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .tab-btn i {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .tab-btn.active i {
            color: var(--primary);
            opacity: 1;
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
            flex: 1;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            position: relative;
            background: #09090b;
        }

        .tab-content.active {
            display: block;
        }

        /* RESULTS VIEW STYLING */
        .results-container {
            display: flex;
            height: 600px;
            /* Fixed height for scrolling */
            border-top: 1px solid #27272a;
        }

        .deep-report-panel {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 12px 14px;
            border-top: 1px solid #27272a;
            border-bottom: 1px solid #27272a;
            background: #0f0f12;
        }

        .deep-report-input {
            width: 100%;
            background: #121217;
            border: 1px solid #2f2f35;
            color: #f4f4f5;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.8rem;
        }

        .deep-report-btn {
            background: var(--primary);
            border: none;
            color: #fff;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .deep-report-btn:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .deep-report-status {
            grid-column: 1 / -1;
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        .file-list-pane {
            width: 280px;
            background: #0c0c0e;
            border-right: 1px solid #27272a;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .file-list-header {
            padding: 12px 16px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #52525b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #27272a;
            background: #121212;
            position: sticky;
            top: 0;
        }

        .file-item {
            padding: 12px 16px;
            font-size: 0.85rem;
            color: #a1a1aa;
            border-bottom: 1px solid #18181b;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #18181b;
            color: #fff;
            padding-left: 20px;
        }

        .file-item.active {
            background: #1d1d20;
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .file-preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #050505;
            overflow: hidden;
        }

        .preview-header {
            padding: 10px 20px;
            border-bottom: 1px solid #27272a;
            background: #09090b;
            color: #d4d4d8;
            font-size: 0.85rem;
            font-family: var(--font-mono);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-content-view {
            flex: 1;
            padding: 1.5rem;

            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #d4d4d8;

            overflow-y: auto;
            white-space: pre-wrap;
        }

        .file-content-view.markdown-render {
            font-family: var(--font-main);
            font-size: 0.92rem;
            line-height: 1.7;
            color: #e4e4e7;
            white-space: normal;
        }

        .file-content-view.markdown-render h1,
        .file-content-view.markdown-render h2,
        .file-content-view.markdown-render h3,
        .file-content-view.markdown-render h4 {
            margin: 1.2rem 0 0.6rem;
            font-weight: 700;
            color: #f4f4f5;
        }

        .file-content-view.markdown-render p {
            margin: 0.5rem 0;
        }

        .file-content-view.markdown-render ul,
        .file-content-view.markdown-render ol {
            margin: 0.6rem 0 0.6rem 1.25rem;
        }

        .file-content-view.markdown-render li {
            margin: 0.25rem 0;
        }

        .file-content-view.markdown-render table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .file-content-view.markdown-render th,
        .file-content-view.markdown-render td {
            border: 1px solid #27272a;
            padding: 0.5rem 0.6rem;
            text-align: left;
        }

        .file-content-view.markdown-render th {
            background: #0f0f12;
            color: #fafafa;
        }

        .file-content-view.markdown-render code {
            background: #111113;
            padding: 0.1rem 0.35rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        .file-content-view.markdown-render pre {
            background: #0b0b0d;
            border: 1px solid #27272a;
            padding: 0.75rem 0.9rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.8rem 0;
        }

        /* INSPECTOR */
        #inspector-content {
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #52525b;
        }

        /* STEPS */
        .step-list {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .step {
            display: flex;
            gap: 1rem;
            opacity: 0.6;
            transition: all 0.4s ease;
        }

        .step.active {
            opacity: 1;
            transform: scale(1.01);
        }

        .step.active .step-card {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.1);
        }

        .step.failed .step-card {
            border-color: var(--danger);
        }

        .step-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 24px;
        }

        .step-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border);
            transition: all 0.3s;
            margin-top: 1.2rem;
        }

        .step.active .step-circle {
            border-color: var(--primary);
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .step.complete .step-circle {
            border-color: var(--success);
            background: var(--success);
        }

        .step-rail {
            flex: 1;
            width: 2px;
            background: var(--border);
            margin: 0.5rem 0;
            opacity: 0.5;
        }

        .step-card {
            flex: 1;
            background: #18181b;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .step-tool {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-tool i {
            color: var(--primary);
            font-size: 0.8rem;
        }

        .step-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .step-meta {
            font-size: 0.75rem;
            color: #52525b;
            font-family: var(--font-mono);
            background: #000;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #27272a;
        }

        .step-preview {
            margin-top: 0.8rem;
            padding: 0.8rem;
            background: #0a0a0a;
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: var(--font-mono);
            border-left: 2px solid var(--primary);
            color: #d4d4d8;
            white-space: pre-wrap;
            /* Preserve formatting */
        }

        /* OVERLAYS & MODALS */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 2rem 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .glass-panel {
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 2.5rem;
            width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: translateY(30px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .glass-panel {
            transform: translateY(0);
        }

        .launch-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
            text-align: center;
            display: block;
        }

        .form-label {
            display: block;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            background: #050505;
            border: 1px solid #333;
            padding: 0.9rem;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            margin-bottom: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .btn-launch {
            width: 100%;
            background: var(--primary);
            border: none;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.8rem;
        }

        .btn-launch:hover {
            background: #4f46e5;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: #27272a;
            color: #fff;
            margin-top: 1rem;
        }

        .btn-secondary:hover {
            background: #3f3f46;
        }

        /* WIZARD */
        .wizard-step {
            display: none;
            animation: fadeIn 0.3s;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-progress {
            display: flex;
            gap: 5px;
            margin-bottom: 2rem;
            justify-content: center;
        }

        .wizard-dot {
            width: 40px;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        .wizard-dot.active {
            background: var(--primary);
        }

        /* UTILS */
        .log-entry {
            margin-bottom: 6px;
            padding-left: 12px;
            border-left: 2px solid #333;
            animation: fadeIn 0.2s;
        }

        .log-ts {
            color: #52525b;
            font-size: 0.7em;
            margin-right: 8px;
            user-select: none;
        }

        .log-type {
            font-weight: bold;
            font-size: 0.75em;
            display: inline-block;
            width: 55px;
        }

        .type-INFO {
            color: var(--primary);
        }

        .type-SUCCESS {
            color: var(--success);
        }

        .type-WARNING {
            color: var(--warning);
        }

        .type-ERROR {
            color: var(--danger);
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* VERDICT PANEL */
        .prediction-hero {
            background: #0d0d12;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .verdict-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }

        .verdict-card {
            background: #121218;
            border: 1px solid #27272a;
            border-radius: 10px;
            padding: 1rem 1.1rem;
        }

        .verdict-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .verdict-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
        }

        .verdict-sub {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .verdict-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid #333;
            color: #d4d4d8;
            background: #0b0b10;
        }

        .verdict-badge.good {
            border-color: var(--verdict_ok);
            color: var(--verdict_ok);
            box-shadow: 0 0 12px var(--verdict_ok_glow);
        }

        .verdict-badge.bad {
            border-color: var(--verdict_bad);
            color: var(--verdict_bad);
            box-shadow: 0 0 12px var(--verdict_bad_glow);
        }

        .verdict-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 0.6rem;
        }

        .check-pill {
            font-size: 0.65rem;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid #333;
            color: #a1a1aa;
            background: #0a0a0c;
        }

        .check-pill.pass {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.08);
        }

        .check-pill.fail {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(239, 68, 68, 0.08);
        }

        .verdict-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        /* CRITIC TOAST */
        .critic-toast {
            position: fixed;
            top: 74px;
            right: 20px;
            width: 380px;
            background: #0f0f13;
            border: 1px solid #2f2f37;
            border-left: 4px solid var(--verdict_bad);
            border-radius: 12px;
            padding: 1rem 1.1rem;
            z-index: 1100;
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.45);
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .critic-toast.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .critic-fallback {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.5);
            background: rgba(245, 158, 11, 0.08);
            color: #f6c976;
            font-size: 0.75rem;
            line-height: 1.35;
        }

        .critic-fallback strong {
            color: #f59e0b;
        }

        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #fcd34d;
        }

        .toast-close {
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            font-size: 1rem;
        }

        .toast-body {
            font-size: 0.8rem;
            color: #d4d4d8;
            line-height: 1.5;
        }

        .toast-meta {
            margin-top: 0.6rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.7rem;
            color: #a1a1aa;
        }

        #global-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            transition: width 0.4s ease;
            width: 0%;
        }

        .advanced-section {
            background: #12141b;
            border: 1px solid #2b3445;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .advanced-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .advanced-title {
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #b5c2ff;
            font-weight: 700;
        }

        .advanced-subtle {
            font-size: 0.72rem;
            color: #8b93a7;
            margin-top: 6px;
        }

        .advanced-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 10px;
        }

        .advanced-meta {
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dashed #2b3445;
            font-size: 0.75rem;
            color: #9ca3af;
        }
    </style>
</head>

<body>

    <!-- SETUP MODAL (WIZARD) -->
    <div id="setup-modal" class="modal-overlay active">
        <div class="glass-panel">

            <!-- STEP 1: Run Setup (Only Step) -->
            <div id="wiz-1" class="wizard-step active">
                <i class="fas fa-satellite-dish launch-icon"></i>
                <h2 style="font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Run Setup</h2>
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label">PARTICIPANT IDENTIFIER (or path)</label>
                    <input type="text" id="input-pid" class="form-input"
                        placeholder="e.g. participant_ID6015951 or 6015951" value="">
                </div>

                <div>
                    <label class="form-label">TARGET PHENOTYPE</label>
                    <input type="text" id="input-target" class="form-input" placeholder="e.g. neuropsychiatric"
                        value="neuropsychiatric">
                </div>
                <div style="margin-top:0.9rem;">
                    <label class="form-label">CONTROL COMPARATOR</label>
                    <input type="text" id="input-control" class="form-input"
                        placeholder="e.g. brain-implicated pathology, but NOT psychiatric"
                        value="brain-implicated pathology, but NOT psychiatric">
                </div>

                <!-- ADVANCED SETTINGS TOGGLE -->
                <div style="margin-bottom: 1.5rem;">
                    <button onclick="toggleAdvanced()"
                        style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer;">
                        <i id="adv-caret" class="fas fa-caret-right"></i> Advanced Configuration
                    </button>
                    <div id="advanced-opts"
                        style="display:none; margin-top:10px; padding:10px; background:#18181b; border-radius:8px; max-height:56vh; overflow-y:auto;">
                        <div class="advanced-section">
                            <div class="advanced-header">
                                <div class="advanced-title">Backend</div>
                            </div>
                            <label class="form-label">Inference Backend</label>
                            <select id="input-backend" class="form-input" onchange="toggleModelInput()"
                                style="padding:0.6rem;">
                                <option value="openrouter" selected>Public API (OpenRouter)</option>
                                <option value="local">Local Hosting (Huggingface)</option>
                            </select>
                            <div class="advanced-subtle">
                                Select your runtime backend. Public API uses OpenRouter routing; Local uses Hugging Face
                                models on this machine.
                            </div>
                        </div>

                        <div id="group-openrouter" class="advanced-section" style="display:block;">
                            <div class="advanced-header">
                                <div class="advanced-title">Public API (OpenRouter)</div>
                                <button type="button" onclick="loadOpenRouterModels()"
                                    style="height:28px; border:1px solid #2b3445; border-radius:8px; padding:0 10px; background:#0f141d; color:#9fb6ff; cursor:pointer; font-size:0.75rem;">
                                    Reload catalog
                                </button>
                            </div>
                            <div class="advanced-grid">
                                <div>
                                    <label class="form-label">Large Language Model</label>
                                    <input type="text" id="input-public-model" class="form-input"
                                        placeholder="gpt-5-nano (recommended)" value="gpt-5-nano"
                                        list="openrouter-models-list" oninput="onPublicModelInput()">
                                    <datalist id="openrouter-models-list"></datalist>
                                </div>
                                <div>
                                    <label class="form-label">Model Context Window</label>
                                    <input type="number" id="input-public-max-context" class="form-input"
                                        placeholder="Auto from model catalog (default 128000)" value="128000">
                                </div>
                                <div>
                                    <label class="form-label">Embedding Model</label>
                                    <input type="text" id="input-embedding-model" class="form-input"
                                        placeholder="text-embedding-3-large" value="text-embedding-3-large"
                                        list="openrouter-embedding-list" oninput="onEmbeddingModelInput()">
                                    <datalist id="openrouter-embedding-list"></datalist>
                                </div>
                            </div>
                            <div class="advanced-meta" id="openrouter-model-meta"></div>
                            <div class="advanced-meta" id="openrouter-embedding-meta"></div>
                        </div>

                        <div id="group-model" class="advanced-section" style="display:none;">
                            <div class="advanced-header">
                                <div class="advanced-title">Local Hosting (Hugging Face)</div>
                                <button type="button" onclick="loadHfModels()"
                                    style="height:28px; border:1px solid #2b3445; border-radius:8px; padding:0 10px; background:#0f141d; color:#9fb6ff; cursor:pointer; font-size:0.75rem;">
                                    Reload catalog
                                </button>
                            </div>
                            <div class="advanced-grid">
                                <div>
                                    <label class="form-label">Local Large Language Model</label>
                                    <input type="text" id="input-model" class="form-input"
                                        placeholder="e.g. Qwen/Qwen2.5-7B" value="Qwen/Qwen2.5-0.5B-Instruct"
                                        list="hf-models-list" oninput="onLocalModelInput()">
                                    <datalist id="hf-models-list"></datalist>
                                </div>
                                <div>
                                    <label class="form-label">Local Context Window</label>
                                    <input type="number" id="input-max-tokens" class="form-input" placeholder="2048"
                                        value="2048">
                                </div>
                                <div>
                                    <label class="form-label">Local Embedding Model</label>
                                    <input type="text" id="input-local-embedding-model" class="form-input"
                                        placeholder="e.g. BAAI/bge-base-en-v1.5" value="BAAI/bge-base-en-v1.5"
                                        list="hf-embedding-list" oninput="onLocalEmbeddingInput()">
                                    <datalist id="hf-embedding-list"></datalist>
                                </div>
                            </div>
                            <div class="advanced-meta" id="hf-model-meta"></div>
                            <div class="advanced-meta" id="hf-embedding-meta"></div>
                        </div>

                        <div id="group-local-advanced" class="advanced-section" style="display:none;">
                            <div class="advanced-header">
                                <div class="advanced-title">Local Runtime Settings</div>
                            </div>
                            <label class="form-label">Local Engine</label>
                            <select id="input-local-engine" class="form-input" style="padding:0.6rem;">
                                <option value="auto" selected>Auto</option>
                                <option value="vllm">vLLM</option>
                                <option value="transformers">Transformers</option>
                            </select>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                                <div>
                                    <label class="form-label">Local Dtype</label>
                                    <select id="input-local-dtype" class="form-input" style="padding:0.6rem;">
                                        <option value="auto" selected>Auto</option>
                                        <option value="float16">float16</option>
                                        <option value="bfloat16">bfloat16</option>
                                        <option value="float32">float32</option>
                                        <option value="fp8">fp8</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Quantization</label>
                                    <select id="input-local-quant" class="form-input" style="padding:0.6rem;">
                                        <option value="" selected>None</option>
                                        <option value="awq">AWQ</option>
                                        <option value="gptq">GPTQ</option>
                                        <option value="4bit">4-bit (bnb)</option>
                                        <option value="8bit">8-bit (bnb)</option>
                                        <option value="fp8">FP8</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                                <div>
                                    <label class="form-label">KV Cache Dtype</label>
                                    <select id="input-local-kv" class="form-input" style="padding:0.6rem;">
                                        <option value="" selected>Auto</option>
                                        <option value="fp8_e4m3">fp8_e4m3 (L40S)</option>
                                        <option value="fp8_e5m2">fp8_e5m2</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Attention Impl</label>
                                    <select id="input-local-attn" class="form-input" style="padding:0.6rem;">
                                        <option value="auto" selected>Auto</option>
                                        <option value="flash_attention_2">FlashAttention2</option>
                                        <option value="sdpa">SDPA</option>
                                        <option value="eager">Eager</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                                <div>
                                    <label class="form-label">Tensor Parallel</label>
                                    <input type="number" id="input-local-tp" class="form-input" placeholder="1"
                                        value="1" style="padding:0.6rem;">
                                </div>
                                <div>
                                    <label class="form-label">Pipeline Parallel</label>
                                    <input type="number" id="input-local-pp" class="form-input" placeholder="1"
                                        value="1" style="padding:0.6rem;">
                                </div>
                            </div>

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                                <div>
                                    <label class="form-label">GPU Memory Utilization</label>
                                    <input type="number" id="input-local-mem" class="form-input" placeholder="0.9"
                                        value="0.9" step="0.01" min="0.1" max="1.0" style="padding:0.6rem;">
                                </div>
                                <div>
                                    <label class="form-label">Max Model Length</label>
                                    <input type="number" id="input-local-maxlen" class="form-input" placeholder="auto"
                                        style="padding:0.6rem;">
                                </div>
                            </div>

                            <div style="display:flex; gap:12px; margin-top:10px; align-items:center;">
                                <label
                                    style="display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#cbd5f5;">
                                    <input type="checkbox" id="input-local-eager"> Enforce eager
                                </label>
                                <label
                                    style="display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#cbd5f5;">
                                    <input type="checkbox" id="input-local-trust" checked> Trust remote code
                                </label>
                            </div>
                        </div>

                        <div class="advanced-section">
                            <div class="advanced-header">
                                <div class="advanced-title">Model and Token Routing</div>
                                <button type="button" onclick="toggleRoleRouting()"
                                    style="height:28px; border:1px solid #2b3445; border-radius:8px; padding:0 10px; background:#0f141d; color:#9fb6ff; cursor:pointer; font-size:0.75rem;">
                                    More Details
                                </button>
                            </div>
                            <div id="role-routing-opts" style="display:none; margin-top:8px;">
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                                    <input id="input-model-orchestrator" class="form-input"
                                        placeholder="Orchestrator model">
                                    <input id="input-model-critic" class="form-input" placeholder="Critic model">
                                    <input id="input-model-integrator" class="form-input"
                                        placeholder="Integrator model">
                                    <input id="input-model-predictor" class="form-input" placeholder="Predictor model">
                                    <input id="input-model-communicator" class="form-input"
                                        placeholder="Communicator model">
                                    <input id="input-model-tool" class="form-input" placeholder="Tool model">
                                </div>
                                <label class="form-label" style="margin-top:8px;">Per-role Max Completion Tokens
                                    (optional)</label>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                                    <input id="input-max-orchestrator" type="number" class="form-input"
                                        placeholder="Orchestrator max tokens">
                                    <input id="input-max-critic" type="number" class="form-input"
                                        placeholder="Critic max tokens">
                                    <input id="input-max-integrator" type="number" class="form-input"
                                        placeholder="Integrator max tokens">
                                    <input id="input-max-predictor" type="number" class="form-input"
                                        placeholder="Predictor max tokens">
                                    <input id="input-max-communicator" type="number" class="form-input"
                                        placeholder="Communicator max tokens">
                                    <input id="input-max-tool-role" type="number" class="form-input"
                                        placeholder="Tool max tokens">
                                </div>
                            </div>
                        </div>

                        <div class="advanced-section">
                            <div class="advanced-header">
                                <div class="advanced-title">Token Budgets</div>
                            </div>
                            <div class="advanced-grid">
                                <div>
                                    <label class="form-label">Total Token Budget</label>
                                    <input type="number" id="input-budget" class="form-input"
                                        placeholder="Default: 1500000" style="padding:0.6rem;">
                                </div>
                                <div>
                                    <label class="form-label">Max Agent Input</label>
                                    <input type="number" id="input-max-agent" class="form-input" placeholder="Auto"
                                        style="padding:0.6rem;">
                                </div>
                                <div>
                                    <label class="form-label">Max Agent Output</label>
                                    <input type="number" id="input-max-agent-output" class="form-input"
                                        placeholder="Auto" style="padding:0.6rem;">
                                </div>
                                <div>
                                    <label class="form-label">Max Tool Input</label>
                                    <input type="number" id="input-max-tool-input" class="form-input"
                                        placeholder="Auto" style="padding:0.6rem;">
                                </div>
                                <div>
                                    <label class="form-label">Max Tool Output</label>
                                    <input type="number" id="input-max-tool" class="form-input" placeholder="Auto"
                                        style="padding:0.6rem;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="btn-final-launch" class="btn-launch" onclick="launchPipeline()">
                    <span>Launch Pipeline</span>
                    <i class="fas fa-rocket"></i>
                </button>
            </div>

        </div>
    </div>

    <!-- RESULT MODAL (RUN SUMMARY) -->
    <div id="result-modal" class="modal-overlay">
        <div class="glass-panel" id="result-panel" style="text-align:center; border: 1px solid var(--verdict_ok);">
            <i class="fas fa-check-circle" id="result-icon"
                style="font-size: 4rem; color: var(--verdict_ok); margin-bottom: 1rem;"></i>
            <h2 style="margin-bottom:0.5rem;">RUN SUMMARY</h2>
            <div id="final-verdict" class="verdict-badge" style="margin: 0.6rem auto 1rem auto;">Pending</div>
            <div
                style="display:flex; justify-content:center; gap:12px; font-size:0.8rem; color:#a1a1aa; margin-bottom:1rem;">
                <span>Probability: <strong id="final-probability" style="color:#fff;">--</strong></span>
                <span>Iterations: <strong id="final-iterations" style="color:#fff;">--</strong></span>
            </div>
            <div id="final-summary"
                style="background:#18181b; padding:1.5rem; border-radius:8px; margin:1.5rem 0; font-family:var(--font-mono); font-size:0.9rem; line-height:1.6; text-align:left; border-left:4px solid var(--verdict_ok);">
                Computing final summary...
            </div>
            <div id="final-checklist" class="verdict-checklist" style="justify-content:center; margin-bottom:1rem;">
            </div>
            <button class="btn-launch" onclick="closeResultModal()" style="background:var(--primary);">
                Review Run Setup
            </button>
        </div>
    </div>

    <!-- CRITIC UNSATISFACTORY TOAST -->
    <div id="critic-toast" class="critic-toast">
        <div class="toast-header">
            <div class="toast-title">Critic: UNSATISFACTORY</div>
            <button class="toast-close" onclick="dismissCriticToast()"><i class="fas fa-times"></i></button>
        </div>
        <div id="critic-toast-body" class="toast-body">Awaiting critic feedback...</div>
        <div id="critic-toast-meta" class="toast-meta"></div>
    </div>

    <!-- MAIN HEADER -->
    <header>
        <div class="brand">
            <i class="fas fa-compass"></i>
            COMPASS <span>DASHBOARD</span>
        </div>

        <div class="stepper" id="stepper">
            <div class="stepper-item">Initializing...</div>
        </div>

        <div style="font-size: 0.75rem; color: var(--text-muted); display:flex; align-items:center; gap:0.5rem;">
            <i class="fas fa-circle" id="status-dot" style="font-size: 6px; color: var(--success);"></i>
            <span id="session-status">System Ready</span>
        </div>

        <div id="global-progress"></div>
    </header>

    <div class="container">
        <!-- MAIN PANEL -->
        <main class="main-panel" id="main-scroller">

            <!-- STATS CARDS -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-title">Elapsed Time</div>
                    <div class="stat-value" id="timer">00:00</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-coins stat-icon"></i>
                    <div class="stat-title">Token Usage</div>
                    <div class="stat-value" id="token-display">0</div>
                </div>
                <!-- REMOVED MEMORY CARD -->
                <div class="stat-card">
                    <i class="fas fa-layer-group stat-icon"></i>
                    <div class="stat-title">Iteration</div>
                    <div class="stat-value"><span id="iter-display">1</span></div>
                </div>
            </div>

            <!-- TIMELINE & TABS -->
            <div class="timeline-wrapper">
                <div class="timeline-tabs" style="display:flex; align-items:center;">
                    <button class="tab-btn active" data-tab="timeline" onclick="switchTab('timeline', this)"><i
                            class="fas fa-stream"></i> Live
                        Execution</button>
                    <button class="tab-btn" data-tab="plan" onclick="switchTab('plan', this);"><i
                            class="fas fa-sitemap"></i> Execution
                        Plan</button>
                    <button class="tab-btn" data-tab="results" onclick="switchTab('results', this); loadResults();"><i
                            class="fas fa-file-alt"></i> Results</button>
                    <button class="tab-btn" data-tab="inspector"
                        onclick="switchTab('inspector', this); loadInputs();"><i class="fas fa-code"></i>
                        Data Inspector</button>
                    <button onclick="toggleTimelineScroll()" id="btn-timeline-scroll"
                        style="margin-left:auto; background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.7rem; font-weight:600; padding:0 10px;">AUTO-FOLLOW:
                        ON</button>
                </div>

                <!-- TAB: TIMELINE -->
                <div id="tab-timeline" class="tab-content active" style="padding:0;">
                    <div class="step-list" id="steps-container">
                        <div style="text-align:center; padding: 4rem; color: var(--text-muted); opacity: 0.5;">
                            <i class="fas fa-satellite-dish" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Pipeline is ready. Launching run...</p>
                        </div>
                    </div>
                </div>

                <!-- TAB: EXECUTION PLAN -->
                <div id="tab-plan" class="tab-content">
                    <div class="results-container">
                        <div class="file-list-pane" style="width:150px;">
                            <div class="file-list-header">Iterations</div>
                            <div id="plan-iter-list">
                                <!-- JS Injected -->
                            </div>
                        </div>
                        <div class="file-preview-pane" id="plan-detail-view" style="padding:1.5rem; overflow-y:auto;">
                            <div style="text-align:center; color:#555; margin-top:3rem;">Waiting for Orchestrator...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RESULTS TAB -->
                <div id="tab-results" class="tab-content" style="padding:0;">
                    <div class="deep-report-panel" id="deep-report-panel" style="display:none;">
                        <input id="deep-focus-modalities" class="deep-report-input" type="text"
                            placeholder="Clinical Focus Areas (optional)" />
                        <input id="deep-general-instruction" class="deep-report-input" type="text"
                            placeholder="Additional Guidance (optional)" />
                        <button id="btn-generate-deep" class="deep-report-btn"
                            onclick="generateDeepPhenotype()">Generate Deep Phenotype</button>
                        <div id="deep-report-status" class="deep-report-status"></div>
                    </div>
                    <div class="results-container">
                        <div class="file-list-pane">
                            <div class="file-list-header">Generated Artifacts</div>
                            <div id="file-list-container">
                                <!-- JS injected -->
                                <div style="padding:1rem; color:#444; font-style:italic;">No files yet...</div>
                            </div>
                        </div>
                        <div class="file-preview-pane">
                            <div class="preview-header">
                                <span id="current-file-name">Preview</span>
                                <span style="opacity:0.5; font-size:0.75rem;">READ-ONLY</span>
                            </div>
                            <div id="file-preview-container" class="file-content-view">
                                <div style="color: #333; text-align: center; margin-top: 4rem;">
                                    <i class="fas fa-file-alt"
                                        style="font-size:2rem; margin-bottom:1rem; opacity:0.3;"></i>
                                    <p>Select a file from the list to inspect contents.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: INSPECTOR -->
                <div id="tab-inspector" class="tab-content" style="padding:0;">
                    <div class="results-container">
                        <div class="file-list-pane">
                            <div class="file-list-header">Input Data Files</div>
                            <div id="input-list-container">
                                <div style="padding:1rem; color:#444; font-style:italic;">Loading...</div>
                            </div>
                        </div>
                        <div class="file-preview-pane">
                            <div class="preview-header">
                                <span id="current-input-name">Preview</span>
                                <span style="opacity:0.5; font-size:0.75rem;">READ-ONLY</span>
                            </div>
                            <div id="input-preview-container" class="file-content-view">
                                <div style="color: #333; text-align: center; margin-top: 4rem;">
                                    <i class="fas fa-database"
                                        style="font-size:2rem; margin-bottom:1rem; opacity:0.3;"></i>
                                    <p>Select an input file to inspect source data.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PREDICTION HERO -->
            <div id="prediction-hero" class="prediction-hero" style="display:none;">
                <div class="verdict-grid">
                    <div class="verdict-card">
                        <div class="verdict-title">Prediction Output</div>
                        <div class="verdict-value" id="prediction-label">--</div>
                        <div class="verdict-sub">Probability: <strong id="prediction-prob">--</strong></div>
                        <div class="verdict-sub">Confidence: <strong id="prediction-conf">--</strong></div>
                    </div>
                    <div class="verdict-card">
                        <div class="verdict-title">Critic Verdict</div>
                        <div class="verdict-value" id="critic-verdict">--</div>
                        <div class="verdict-sub" id="critic-summary">Awaiting critic evaluation...</div>
                        <div class="critic-fallback" id="critic-fallback" style="display:none;"></div>
                        <div class="verdict-checklist" id="critic-checklist"></div>
                    </div>
                </div>
                <div class="verdict-actions">
                    <button onclick="document.getElementById('result-modal').classList.add('active')"
                        style="background:none; border:1px solid var(--verdict_ok); color:var(--verdict_ok); padding:6px 12px; border-radius:4px; cursor:pointer;">
                        View Run Summary
                    </button>
                </div>
            </div>

        </main>

        <!-- SIDEBAR LOGS -->
        <aside class="log-panel" id="log-panel">
            <div class="log-header">
                <span><i class="fas fa-terminal" style="margin-right:8px;"></i> System Logs</span>
                <div style="display:flex; gap:10px;">
                    <i class="fas fa-sync-alt" id="activity-spinner" style="opacity:0;"></i>
                    <button onclick="toggleLogScroll()" id="btn-log-scroll"
                        style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.7rem; font-weight:600;">AUTO:
                        ON</button>
                </div>
            </div>
            <div class="log-content" id="log-container"></div>
        </aside>
    </div>

    <!-- LOGIC -->
    <script src="/static/marked.min.js"></script>
    <script>
        // State
        let latestEventId = 0;
        let isRunning = false;
        let autoScrollTimeline = true;
        let autoScrollLogs = true;
        let startTime = null;
        let currentIteration = 1;
        let hasShownResultModal = false;
        let uiSelectedPlanIter = null; // Track user selection for Plan view
        let deepReportStatusSeen = 'idle';
        let openRouterModels = [];
        let openRouterEmbeddingModels = [];
        let openRouterCatalogLoaded = false;
        let openRouterCatalogLoading = false;
        let hfModels = [];
        let hfCatalogLoaded = false;
        let hfCatalogLoading = false;
        let hfEmbeddingModels = [];
        let hfEmbeddingCatalogLoaded = false;
        let hfEmbeddingCatalogLoading = false;
        let hfModelDetailCache = {};

        // WIZARD LOGIC
        function toggleModelInput() {
            const val = document.getElementById('input-backend').value;
            const isLocal = val === 'local';
            document.getElementById('group-model').style.display = isLocal ? 'block' : 'none';
            document.getElementById('group-local-advanced').style.display = isLocal ? 'block' : 'none';
            document.getElementById('group-openrouter').style.display = isLocal ? 'none' : 'block';
        }

        function toggleRoleRouting() {
            const wrap = document.getElementById('role-routing-opts');
            if (!wrap) return;
            wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
        }

        function normalizeModelId(raw) {
            const v = String(raw || '').trim();
            if (!v) return '';
            if (v.includes('/')) return v;
            if (v.startsWith('gpt-') || v.startsWith('text-embedding-') || v.startsWith('o1') || v.startsWith('o3') || v.startsWith('o4')) {
                return `openai/${v}`;
            }
            return v;
        }

        function isEmbeddingModelId(modelId) {
            const v = String(modelId || '').toLowerCase();
            if (!v) return false;
            return (
                v.includes('embedding') ||
                v.includes('embed') ||
                v.includes('text-embedding') ||
                v.includes('bge') ||
                v.includes('e5') ||
                v.includes('gte')
            );
        }

        function isOpenRouterEmbeddingRecord(model) {
            if (!model) return false;
            if (typeof model.is_embedding === 'boolean') {
                return model.is_embedding;
            }
            return isEmbeddingModelId(model.id);
        }

        function _stripVariantSuffix(modelId) {
            const value = String(modelId || '');
            const idx = value.indexOf(':');
            return idx >= 0 ? value.slice(0, idx) : value;
        }

        function _modelSlug(modelId) {
            const base = _stripVariantSuffix(String(modelId || '').trim().toLowerCase());
            const parts = base.split('/');
            return parts[parts.length - 1] || base;
        }

        function resolveOpenRouterModel(rawInput, modelPool = null) {
            const pool = Array.isArray(modelPool) ? modelPool : openRouterModels;
            const query = String(rawInput || '').trim();
            if (!query) return null;
            const normalized = normalizeModelId(query);
            const direct = pool.find((m) => m.id === query || m.id === normalized);
            if (direct) return direct;

            const normalizedBase = _stripVariantSuffix(normalized);
            const byBase = pool.filter((m) => _stripVariantSuffix(m.id) === normalizedBase);
            if (byBase.length === 1) return byBase[0];
            if (byBase.length > 1) {
                const exactProvider = byBase.find((m) => m.id.startsWith(normalizedBase + ':')) || byBase[0];
                return exactProvider;
            }

            // Provider-less fallback (e.g. text-embedding-3-large -> openai/text-embedding-3-large:free).
            const querySlug = _modelSlug(query);
            const bySlug = pool.filter((m) => _modelSlug(m.id) === querySlug);
            if (bySlug.length === 1) return bySlug[0];
            if (bySlug.length > 1) return bySlug[0];
            return null;
        }

        function _fillOpenRouterDatalist(listId, models) {
            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = '';
            (models || []).forEach((m) => {
                const opt = document.createElement('option');
                opt.value = m.id;
                list.appendChild(opt);
            });
        }

        function _scoreMatch(query, candidate) {
            if (!query || !candidate) return -1;
            const q = query.toLowerCase();
            const c = candidate.toLowerCase();
            if (c === q) return 100;
            if (c.startsWith(q)) return 50 + q.length;
            if (c.includes(q)) return 25 + q.length;
            if (q.includes(c)) return 10;
            return -1;
        }

        function _bestMatchModel(inputValue, filterFn = null) {
            const normalized = normalizeModelId(inputValue);
            const candidates = (openRouterModels || []).filter((m) => m && m.id);
            let best = null;
            let bestScore = -1;
            candidates.forEach((m) => {
                if (filterFn && !filterFn(m)) return;
                const score = Math.max(_scoreMatch(normalized, m.id), _scoreMatch(inputValue, m.id));
                if (score > bestScore) {
                    bestScore = score;
                    best = m;
                }
            });
            if (bestScore <= 0) return null;
            return best;
        }

        async function loadOpenRouterModels() {
            const meta = document.getElementById('openrouter-model-meta');
            if (!meta) return;
            if (openRouterCatalogLoading) return;
            openRouterCatalogLoading = true;
            meta.textContent = 'Loading model catalog...';
            try {
                const res = await fetch('/api/openrouter/models');
                const data = await res.json();
                if (!res.ok || !data.models) {
                    throw new Error(data.error || 'Model catalog unavailable');
                }
                openRouterModels = data.models || [];
                _fillOpenRouterDatalist('openrouter-models-list', openRouterModels);
                try {
                    const embRes = await fetch('/api/openrouter/embedding-models');
                    const embData = await embRes.json();
                    if (embRes.ok && embData.models) {
                        openRouterEmbeddingModels = embData.models || [];
                    } else {
                        openRouterEmbeddingModels = openRouterModels.filter((m) => isOpenRouterEmbeddingRecord(m));
                    }
                } catch (e) {
                    openRouterEmbeddingModels = openRouterModels.filter((m) => isOpenRouterEmbeddingRecord(m));
                }
                _fillOpenRouterDatalist(
                    'openrouter-embedding-list',
                    openRouterEmbeddingModels.length ? openRouterEmbeddingModels : openRouterModels.filter((m) => isOpenRouterEmbeddingRecord(m))
                );
                openRouterCatalogLoaded = true;
                meta.textContent = 'Catalog loaded.';
                onPublicModelInput(true);
                onEmbeddingModelInput(true);
            } catch (e) {
                meta.textContent = `Model catalog lookup failed: ${e.message}`;
            } finally {
                openRouterCatalogLoading = false;
            }
        }

        function updateOpenRouterContextFromCatalog(selectedModelId = null) {
            const rawSelected = selectedModelId || document.getElementById('input-public-model').value;
            const found = resolveOpenRouterModel(rawSelected);
            const maxCtxInput = document.getElementById('input-public-max-context');
            const meta = document.getElementById('openrouter-model-meta');
            if (!found || !meta) return;
            if (maxCtxInput && found.context_length) {
                maxCtxInput.value = found.context_length;
            }
            const eurRate = parseFloat(String(window.__compassEurPerUsd || '')) || parseFloat(String((window.localStorage && localStorage.getItem('COMPASS_EUR_PER_USD')) || '')) || 1.0;
            const promptPerM = found.prompt_price ? (parseFloat(found.prompt_price) * 1_000_000 * eurRate) : null;
            const completionPerM = found.completion_price ? (parseFloat(found.completion_price) * 1_000_000 * eurRate) : null;
            const promptLine = promptPerM !== null ? `${promptPerM.toFixed(2)} / 1M input tokens` : 'Not provided';
            const completionLine = completionPerM !== null ? `${completionPerM.toFixed(2)} / 1M output tokens` : 'Not provided';
            meta.innerHTML = [
                `Catalog info retrieved for ${found.id}.`,
                `Context window: ${found.context_length ? found.context_length.toLocaleString() : 'Unknown'} tokens`,
                `Price (input): ${promptLine}`,
                `Price (output): ${completionLine}`
            ].map(line => `<div>${line}</div>`).join('');
        }

        function updateEmbeddingMetaFromCatalog(selectedModelId = null) {
            const rawSelected = selectedModelId || document.getElementById('input-embedding-model').value;
            const found = resolveOpenRouterModel(rawSelected, openRouterEmbeddingModels)
                || resolveOpenRouterModel(rawSelected, openRouterModels.filter((m) => isOpenRouterEmbeddingRecord(m)));
            const meta = document.getElementById('openrouter-embedding-meta');
            if (!meta) return;
            if (!found) {
                meta.textContent = '';
                return;
            }
            if (!isOpenRouterEmbeddingRecord(found)) {
                meta.textContent = 'Selected model is not an embedding model in catalog.';
                return;
            }
            const eurRate = parseFloat(String(window.__compassEurPerUsd || '')) || parseFloat(String((window.localStorage && localStorage.getItem('COMPASS_EUR_PER_USD')) || '')) || 1.0;
            const promptPerM = found.prompt_price ? (parseFloat(found.prompt_price) * 1_000_000 * eurRate) : null;
            const promptLine = promptPerM !== null ? `${promptPerM.toFixed(2)} / 1M input tokens` : 'Not provided';
            const lines = [
                `Catalog info retrieved for ${found.id}.`,
                `Price (input): ${promptLine}`,
            ];
            if (found.context_length) {
                lines.splice(1, 0, `Context window: ${found.context_length.toLocaleString()} tokens`);
            }
            meta.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
        }

        function _parsePositiveInt(value) {
            const parsed = parseInt(String(value || ''), 10);
            return Number.isFinite(parsed) && parsed > 0 ? parsed : 0;
        }

        function _setAutoBudgetInput(inputEl, value, force = false) {
            if (!inputEl) return;
            const isAuto = inputEl.dataset.auto === 'true';
            if (force || !inputEl.value || isAuto) {
                inputEl.value = Math.max(1, Math.floor(value));
                inputEl.dataset.auto = 'true';
            }
        }

        function getActiveContextWindow() {
            const backend = document.getElementById('input-backend')?.value || 'openrouter';
            if (backend === 'local') {
                const maxLen = _parsePositiveInt(document.getElementById('input-local-maxlen')?.value);
                if (maxLen) return maxLen;
                const maxTokens = _parsePositiveInt(document.getElementById('input-max-tokens')?.value);
                if (maxTokens) return maxTokens;
                return 2048;
            }
            const publicCtx = _parsePositiveInt(document.getElementById('input-public-max-context')?.value);
            return publicCtx || 128000;
        }

        function applyTokenBudgetDefaults(force = false) {
            const ctx = getActiveContextWindow();
            if (!ctx) return;
            const maxAgentInput = Math.floor(ctx * 0.95);
            const maxToolInput = Math.floor(ctx * 0.40);
            const maxAgentOutput = Math.floor(ctx * 0.25);
            const maxToolOutput = Math.floor(ctx * 0.25);
            _setAutoBudgetInput(document.getElementById('input-max-agent'), maxAgentInput, force);
            _setAutoBudgetInput(document.getElementById('input-max-agent-output'), maxAgentOutput, force);
            _setAutoBudgetInput(document.getElementById('input-max-tool-input'), maxToolInput, force);
            _setAutoBudgetInput(document.getElementById('input-max-tool'), maxToolOutput, force);
        }

        function onPublicModelInput(fromCatalogLoad = false) {
            const input = document.getElementById('input-public-model');
            if (!input) return;
            if (!openRouterCatalogLoaded && !fromCatalogLoad) {
                loadOpenRouterModels();
                return;
            }
            if (!input.value) {
                document.getElementById('openrouter-model-meta').textContent = '';
                return;
            }
            const exact = resolveOpenRouterModel(input.value);
            if (exact) {
                updateOpenRouterContextFromCatalog(exact.id);
                applyTokenBudgetDefaults();
                return;
            }
            document.getElementById('openrouter-model-meta').textContent = 'Large Language Model not found in catalog; using manual value.';
        }

        function onEmbeddingModelInput(fromCatalogLoad = false) {
            const input = document.getElementById('input-embedding-model');
            const meta = document.getElementById('openrouter-embedding-meta');
            if (!input || !meta) return;
            if (!openRouterCatalogLoaded && !fromCatalogLoad) {
                loadOpenRouterModels();
                return;
            }
            if (!input.value) {
                meta.textContent = '';
                return;
            }
            const exact = resolveOpenRouterModel(input.value, openRouterEmbeddingModels)
                || resolveOpenRouterModel(input.value, openRouterModels.filter((m) => isOpenRouterEmbeddingRecord(m)));
            if (exact) {
                updateEmbeddingMetaFromCatalog(exact.id);
                return;
            }
            meta.textContent = 'Embedding model not found in catalog; using manual value.';
        }

        function collectRoleSettings() {
            const roleModels = {
                orchestrator: document.getElementById('input-model-orchestrator').value || null,
                critic: document.getElementById('input-model-critic').value || null,
                integrator: document.getElementById('input-model-integrator').value || null,
                predictor: document.getElementById('input-model-predictor').value || null,
                communicator: document.getElementById('input-model-communicator').value || null,
                tool: document.getElementById('input-model-tool').value || null,
            };
            const roleMaxTokens = {
                orchestrator: document.getElementById('input-max-orchestrator').value || null,
                critic: document.getElementById('input-max-critic').value || null,
                integrator: document.getElementById('input-max-integrator').value || null,
                predictor: document.getElementById('input-max-predictor').value || null,
                communicator: document.getElementById('input-max-communicator').value || null,
                tool: document.getElementById('input-max-tool-role').value || null,
            };
            return { roleModels, roleMaxTokens };
        }

        function toggleAdvanced() {
            const el = document.getElementById('advanced-opts');
            const caret = document.getElementById('adv-caret');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                caret.classList.remove('fa-caret-right');
                caret.classList.add('fa-caret-down');
            } else {
                el.style.display = 'none';
                caret.classList.remove('fa-caret-down');
                caret.classList.add('fa-caret-right');
            }
        }

        async function launchPipeline() {
            const pid = document.getElementById('input-pid').value;
            const target = document.getElementById('input-target').value;
            const control = document.getElementById('input-control').value;

            // Advanced settings
            const budget = document.getElementById('input-budget').value;
            const maxAgent = document.getElementById('input-max-agent').value;
            const maxTool = document.getElementById('input-max-tool').value;

            // NEW: Granular controls
            const maxAgentOutput = document.getElementById('input-max-agent-output').value;
            const maxToolInput = document.getElementById('input-max-tool-input').value;

            const backend = document.getElementById('input-backend').value;
            const publicModel = document.getElementById('input-public-model').value;
            const publicMaxContext = document.getElementById('input-public-max-context').value;
            const embeddingModel = document.getElementById('input-embedding-model').value;
            const model = document.getElementById('input-model').value;
            const localEmbeddingModel = document.getElementById('input-local-embedding-model')
                ? document.getElementById('input-local-embedding-model').value
                : null;
            const maxTokens = document.getElementById('input-max-tokens').value;
            const localEngine = document.getElementById('input-local-engine').value;
            const localDtype = document.getElementById('input-local-dtype').value;
            const localQuant = document.getElementById('input-local-quant').value;
            const localKv = document.getElementById('input-local-kv').value;
            const localAttn = document.getElementById('input-local-attn').value;
            const localTp = document.getElementById('input-local-tp').value;
            const localPp = document.getElementById('input-local-pp').value;
            const localMem = document.getElementById('input-local-mem').value;
            const localMaxLen = document.getElementById('input-local-maxlen').value;
            const localEager = document.getElementById('input-local-eager').checked;
            const localTrust = document.getElementById('input-local-trust').checked;
            const routing = collectRoleSettings();

            if (!pid) return alert("Participant ID required");

            const btn = document.getElementById('btn-final-launch');
            btn.innerHTML = '<i class="fas fa-circle-notch spin"></i> Launching...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/launch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: pid, target: target, control: control,
                        total_budget: budget ? parseInt(budget) : null,
                        max_agent_input: maxAgent ? parseInt(maxAgent) : null,
                        max_tool_output: maxTool ? parseInt(maxTool) : null,
                        max_agent_output: maxAgentOutput ? parseInt(maxAgentOutput) : null,
                        max_tool_input: maxToolInput ? parseInt(maxToolInput) : null,
                        backend: backend,
                        public_model: publicModel || null,
                        public_max_context_tokens: publicMaxContext ? parseInt(publicMaxContext) : null,
                        embedding_model: embeddingModel || null,
                        model: model,
                        local_embedding_model: localEmbeddingModel || null,
                        max_tokens: maxTokens ? parseInt(maxTokens) : null,
                        local_engine: localEngine,
                        local_dtype: localDtype,
                        local_quant: localQuant || null,
                        local_kv_cache_dtype: localKv || null,
                        local_attn: localAttn,
                        local_tensor_parallel: localTp ? parseInt(localTp) : null,
                        local_pipeline_parallel: localPp ? parseInt(localPp) : null,
                        local_gpu_mem_util: localMem ? parseFloat(localMem) : null,
                        local_max_model_len: localMaxLen ? parseInt(localMaxLen) : null,
                        local_enforce_eager: localEager,
                        local_trust_remote_code: localTrust,
                        role_models: routing.roleModels,
                        role_max_tokens: routing.roleMaxTokens
                    })
                });
                const data = await res.json();

                if (data.status === 'started') {
                    setTimeout(() => {
                        document.getElementById('setup-modal').classList.remove('active');
                        document.getElementById('session-status').textContent = "Pipeline Active";
                        document.getElementById('status-dot').classList.add('pulse');
                        isRunning = true;
                    }, 800);
                }
            } catch (e) {
                console.error(e);
                btn.innerHTML = 'Launch Failed';
                btn.disabled = false;
                alert("Connection failed.");
            }
        }

        async function loadHfModels(query = '') {
            const meta = document.getElementById('hf-model-meta');
            if (!meta) return;
            if (hfCatalogLoading) return;
            hfCatalogLoading = true;
            meta.textContent = 'Loading Hugging Face catalog...';
            try {
                const url = query
                    ? `/api/hf/models?task=llm&q=${encodeURIComponent(query)}`
                    : '/api/hf/models?task=llm';
                const res = await fetch(url);
                const data = await res.json();
                if (!res.ok || !data.models) {
                    throw new Error(data.error || 'Catalog unavailable');
                }
                hfModels = data.models || [];
                const list = document.getElementById('hf-models-list');
                if (list) {
                    list.innerHTML = '';
                    hfModels.forEach((m) => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        list.appendChild(opt);
                    });
                }
                hfCatalogLoaded = true;
                meta.textContent = 'Catalog loaded.';
                onLocalModelInput(true);
            } catch (e) {
                meta.textContent = `Catalog lookup failed: ${e.message}`;
            } finally {
                hfCatalogLoading = false;
            }
        }

        async function loadHfEmbeddings(query = '') {
            const meta = document.getElementById('hf-embedding-meta');
            if (!meta) return;
            if (hfEmbeddingCatalogLoading) return;
            hfEmbeddingCatalogLoading = true;
            meta.textContent = 'Loading Hugging Face embeddings...';
            try {
                const q = query || '';
                const url = q
                    ? `/api/hf/models?task=embedding&q=${encodeURIComponent(q)}`
                    : '/api/hf/models?task=embedding';
                const res = await fetch(url);
                const data = await res.json();
                if (!res.ok || !data.models) {
                    throw new Error(data.error || 'Catalog unavailable');
                }
                hfEmbeddingModels = data.models || [];
                const list = document.getElementById('hf-embedding-list');
                if (list) {
                    list.innerHTML = '';
                    hfEmbeddingModels.forEach((m) => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        list.appendChild(opt);
                    });
                }
                hfEmbeddingCatalogLoaded = true;
                meta.textContent = 'Catalog loaded.';
                onLocalEmbeddingInput(true);
            } catch (e) {
                meta.textContent = `Catalog lookup failed: ${e.message}`;
            } finally {
                hfEmbeddingCatalogLoading = false;
            }
        }

        async function fetchHfModelDetail(modelId, metaEl, maxCtxEl = null) {
            const cached = hfModelDetailCache[modelId];
            if (cached) return cached;
            const res = await fetch(`/api/hf/model/${encodeURIComponent(modelId)}`);
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.error || 'Model detail unavailable');
            }
            hfModelDetailCache[modelId] = data;
            return data;
        }

        async function onLocalModelInput(fromCatalogLoad = false) {
            const input = document.getElementById('input-model');
            const meta = document.getElementById('hf-model-meta');
            const maxCtx = document.getElementById('input-max-tokens');
            if (!input || !meta) return;
            if (!hfCatalogLoaded && !fromCatalogLoad) {
                loadHfModels(input.value || '');
                return;
            }
            if (!input.value) {
                meta.textContent = '';
                return;
            }
            const exact = hfModels.find((m) => m.id === input.value);
            if (!exact) {
                meta.textContent = 'Model not found in catalog; using manual value.';
                if (!fromCatalogLoad && input.value.length >= 2) {
                    loadHfModels(input.value);
                }
                if (input.value.length >= 3) {
                    try {
                        const data = await fetchHfModelDetail(input.value, meta, maxCtx);
                        if (data.is_embedding) {
                            meta.textContent = 'Selected model is an embedding model; choose it in Local Embedding Model.';
                            return;
                        }
                const ctxVal = parseInt(data.context_length || 0, 10);
                if (ctxVal && maxCtx) {
                    maxCtx.value = ctxVal;
                }
                applyTokenBudgetDefaults();
                const downloads = data.downloads ? data.downloads.toLocaleString() : 'N/A';
                const likes = data.likes ? data.likes.toLocaleString() : 'N/A';
                meta.innerHTML = [
                    `Catalog info retrieved for ${data.id || input.value}.`,
                    `Context window: ${ctxVal ? ctxVal.toLocaleString() : 'Unknown'} tokens`,
                            `Downloads: ${downloads}`,
                            `Likes: ${likes}`
                        ].map(line => `<div>${line}</div>`).join('');
                    } catch (e) {
                        meta.textContent = `Model detail lookup failed: ${e.message}`;
                    }
                }
                return;
            }
            try {
                const data = await fetchHfModelDetail(exact.id, meta, maxCtx);
                if (data.is_embedding) {
                    meta.textContent = 'Selected model is an embedding model; choose it in Local Embedding Model.';
                    return;
                }
            const ctxVal = parseInt(data.context_length || 0, 10);
            if (ctxVal && maxCtx) {
                maxCtx.value = ctxVal;
            }
            applyTokenBudgetDefaults();
            const downloads = data.downloads ? data.downloads.toLocaleString() : 'N/A';
            const likes = data.likes ? data.likes.toLocaleString() : 'N/A';
            meta.innerHTML = [
                `Catalog info retrieved for ${data.id || exact.id}.`,
                `Context window: ${ctxVal ? ctxVal.toLocaleString() : 'Unknown'} tokens`,
                    `Downloads: ${downloads}`,
                    `Likes: ${likes}`
                ].map(line => `<div>${line}</div>`).join('');
            } catch (e) {
                meta.textContent = `Model detail lookup failed: ${e.message}`;
            }
        }

        async function onLocalEmbeddingInput(fromCatalogLoad = false) {
            const input = document.getElementById('input-local-embedding-model');
            const meta = document.getElementById('hf-embedding-meta');
            if (!input || !meta) return;
            if (!hfEmbeddingCatalogLoaded && !fromCatalogLoad) {
                loadHfEmbeddings(input.value || '');
                return;
            }
            if (!input.value) {
                meta.textContent = '';
                return;
            }
            const exact = hfEmbeddingModels.find((m) => m.id === input.value);
            if (!exact) {
                meta.textContent = 'Embedding model not found in catalog; using manual value.';
                if (!fromCatalogLoad && input.value.length >= 2) {
                    loadHfEmbeddings(input.value);
                }
                if (input.value.length >= 3) {
                    try {
                        const data = await fetchHfModelDetail(input.value, meta);
                        if (!data.is_embedding) {
                            meta.textContent = 'Selected model is not classified as an embedding model.';
                            return;
                        }
                        const downloads = data.downloads ? data.downloads.toLocaleString() : 'N/A';
                        const likes = data.likes ? data.likes.toLocaleString() : 'N/A';
                        const lines = [
                            `Catalog info retrieved for ${data.id || input.value}.`,
                            `Downloads: ${downloads}`,
                            `Likes: ${likes}`
                        ];
                        if (data.context_length) {
                            lines.splice(2, 0, `Context window: ${data.context_length.toLocaleString()} tokens`);
                        }
                        meta.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
                    } catch (e) {
                        meta.textContent = `Model detail lookup failed: ${e.message}`;
                    }
                }
                return;
            }
            try {
                const data = await fetchHfModelDetail(exact.id, meta);
                if (!data.is_embedding) {
                    meta.textContent = 'Selected model is not classified as an embedding model.';
                    return;
                }
                const downloads = data.downloads ? data.downloads.toLocaleString() : 'N/A';
                const likes = data.likes ? data.likes.toLocaleString() : 'N/A';
                const lines = [
                    `Catalog info retrieved for ${data.id || exact.id}.`,
                    `Downloads: ${downloads}`,
                    `Likes: ${likes}`
                ];
                if (data.context_length) {
                    lines.splice(2, 0, `Context window: ${data.context_length.toLocaleString()} tokens`);
                }
                meta.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
            } catch (e) {
                meta.textContent = `Model detail lookup failed: ${e.message}`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (window.marked && typeof window.marked.setOptions === 'function') {
                window.marked.setOptions({ gfm: true, breaks: true });
            }
            toggleModelInput();
            loadOpenRouterModels();
            loadHfModels();
            loadHfEmbeddings();
            applyTokenBudgetDefaults(true);
            ['input-max-agent', 'input-max-agent-output', 'input-max-tool-input', 'input-max-tool'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        el.dataset.auto = 'false';
                    });
                }
            });
            const publicCtx = document.getElementById('input-public-max-context');
            if (publicCtx) publicCtx.addEventListener('input', () => applyTokenBudgetDefaults());
            const localMaxTokens = document.getElementById('input-max-tokens');
            if (localMaxTokens) localMaxTokens.addEventListener('input', () => applyTokenBudgetDefaults());
            const localMaxLen = document.getElementById('input-local-maxlen');
            if (localMaxLen) localMaxLen.addEventListener('input', () => applyTokenBudgetDefaults());
            const backendSelect = document.getElementById('input-backend');
            if (backendSelect) backendSelect.addEventListener('change', () => applyTokenBudgetDefaults());
        });

        function toggleLogScroll() {
            autoScrollLogs = !autoScrollLogs;
            document.getElementById('btn-log-scroll').textContent = autoScrollLogs ? 'AUTO: ON' : 'AUTO: OFF';
        }

        function toggleTimelineScroll() {
            autoScrollTimeline = !autoScrollTimeline;
            const btn = document.getElementById('btn-timeline-scroll');
            btn.textContent = autoScrollTimeline ? 'AUTO-FOLLOW: ON' : 'AUTO-FOLLOW: OFF';
            btn.style.opacity = autoScrollTimeline ? '1' : '0.5';
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            const targetBtn = btn || document.querySelector(`.tab-btn[data-tab="${tab}"]`) || (typeof event !== 'undefined' ? event.target : null);
            if (targetBtn) targetBtn.classList.add('active');
        }

        async function closeResultModal() {
            document.getElementById('result-modal').classList.remove('active');
            switchTab('results');
            await loadResults();
            await openStandardReport();
        }

        async function generateDeepPhenotype() {
            const btn = document.getElementById('btn-generate-deep');
            const statusEl = document.getElementById('deep-report-status');
            const focus = document.getElementById('deep-focus-modalities').value || '';
            const guidance = document.getElementById('deep-general-instruction').value || '';
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch spin"></i> Generating...';
            statusEl.textContent = 'Queued deep phenotype generation...';
            try {
                const res = await fetch('/api/deep_phenotype/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        focus_modalities: focus,
                        general_instruction: guidance
                    })
                });
                const data = await res.json();
                if (!res.ok || data.status !== 'started') {
                    throw new Error(data.error || 'Failed to start deep phenotype generation.');
                }
            } catch (e) {
                statusEl.textContent = `Deep phenotype failed to start: ${e.message}`;
                btn.disabled = false;
                btn.textContent = 'Generate Deep Phenotype';
            }
        }

        function updateDeepReportUi(state) {
            const status = (state.deep_report_status || 'idle').toLowerCase();
            const statusEl = document.getElementById('deep-report-status');
            const btn = document.getElementById('btn-generate-deep');
            const panel = document.getElementById('deep-report-panel');
            if (!statusEl || !btn) return;

            const maxIters = state.max_iterations || 1;
            const criticIter = state.critic && state.critic.iteration ? state.critic.iteration : null;
            const isFinalVerdict = Boolean(
                state.completed ||
                (state.critic && (
                    state.critic.verdict === 'SATISFACTORY' ||
                    (criticIter !== null ? criticIter >= maxIters : false)
                ))
            );

            const shouldShow = isFinalVerdict && status !== 'completed';
            if (panel) {
                panel.style.display = shouldShow ? 'grid' : 'none';
            }
            if (!shouldShow) {
                statusEl.textContent = '';
                return;
            }

            if (status === 'running' || status === 'queued') {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle-notch spin"></i> Generating...';
            } else {
                btn.disabled = false;
                btn.textContent = 'Generate Deep Phenotype';
            }

            if (status === 'completed') {
                statusEl.textContent = '';
            } else if (status === 'failed') {
                statusEl.textContent = `Deep phenotype generation failed: ${state.deep_report_error || 'Unknown error'}`;
            } else if (status === 'running') {
                statusEl.textContent = 'Generating deep phenotype report...';
            } else if (status === 'queued') {
                statusEl.textContent = 'Deep phenotype generation queued...';
            } else {
                statusEl.textContent = '';
            }
        }

        function dismissCriticToast() {
            const toast = document.getElementById('critic-toast');
            toast.classList.remove('active');
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/\'/g, "&#039;");
        }

        function normalizeClassification(raw) {
            if (!raw) return 'UNKNOWN';
            const upper = String(raw).toUpperCase();
            if (upper.includes('CONTROL')) return 'CONTROL';
            if (upper.includes('CASE')) return 'CASE';
            return String(raw).trim();
        }

        const CHECKLIST_LABELS = {
            has_binary_outcome: "Binary outcome",
            valid_probability: "Valid probability",
            sufficient_coverage: "Coverage",
            evidence_based_reasoning: "Evidence-based",
            clinically_relevant: "Clinical relevance",
            logically_coherent: "Coherence",
            critical_domains_processed: "Critical domains"
        };

        function buildChecklistPills(checklist, compact = true) {
            if (!checklist) return '';
            const entries = Object.keys(CHECKLIST_LABELS).map(key => ({
                key,
                label: CHECKLIST_LABELS[key],
                pass: Boolean(checklist[key])
            }));
            const passCount = entries.filter(e => e.pass).length;
            const total = entries.length || 7;
            const failed = entries.filter(e => !e.pass);

            let pills = `<span class="check-pill ${failed.length ? 'fail' : 'pass'}">${passCount}/${total} checks</span>`;
            const list = compact ? failed : entries;
            if (list.length === 0 && !compact) {
                return pills;
            }
            list.forEach(item => {
                const cls = item.pass ? 'pass' : 'fail';
                const label = item.pass ? ` ${item.label}` : ` ${item.label}`;
                pills += `<span class="check-pill ${cls}">${label}</span>`;
            });
            return pills;
        }

        function formatFallbackMessage(criticData) {
            if (!criticData || !criticData.fallback_used) return '';
            const reason = (criticData.fallback_reason || 'invalid_json').replace(/_/g, ' ');
            const recommendation = criticData.fallback_recommendation || 'Strongly recommend using a higher-quality critic model.';
            return `<strong>Fallback Mode:</strong> Critic output required repair (${escapeHtml(reason)}). ${escapeHtml(recommendation)}`;
        }

        function showCriticToast(criticData) {
            if (!criticData || criticData.verdict !== 'UNSATISFACTORY') return;
            const toast = document.getElementById('critic-toast');
            const title = toast.querySelector('.toast-title');
            const body = document.getElementById('critic-toast-body');
            const meta = document.getElementById('critic-toast-meta');

            title.textContent = `Critic: ${criticData.verdict}`;
            title.style.color = 'var(--verdict_bad)';

            const summary = criticData.summary || 'Critic found issues requiring re-orchestration.';
            const weaknesses = (criticData.weaknesses || []).slice(0, 2);
            const suggestions = (criticData.improvement_suggestions || []).slice(0, 1);

            const weaknessText = weaknesses.length ? `Key issues: ${escapeHtml(weaknesses.join(' | '))}` : '';
            let suggestionLabel = '';
            if (suggestions.length) {
                const sugg = suggestions[0];
                if (typeof sugg === 'string') {
                    suggestionLabel = sugg;
                } else {
                    suggestionLabel = sugg.issue || sugg.suggestion || '';
                }
            }
            const suggestionText = suggestionLabel ? `Fix: ${escapeHtml(suggestionLabel)}` : '';
            const fallbackText = criticData.fallback_used ? `<div class="critic-fallback" style="margin-top:8px;">${formatFallbackMessage(criticData)}</div>` : '';

            body.innerHTML = `
                <div>${escapeHtml(summary)}</div>
                ${weaknessText ? `<div style="margin-top:6px;">${weaknessText}</div>` : ''}
                ${suggestionText ? `<div style="margin-top:6px;">${suggestionText}</div>` : ''}
                ${fallbackText}
                <div style="margin-top:6px;">${buildChecklistPills(criticData.checklist, true)}</div>
            `;

            const metaItems = [];
            const lastState = window.__lastState || {};
            if (lastState.iteration && lastState.max_iterations) {
                metaItems.push(`Iteration: ${lastState.iteration}/${lastState.max_iterations}`);
            }
            if (typeof criticData.composite_score === 'number') {
                metaItems.push(`Score: ${criticData.composite_score.toFixed(2)}`);
            }
            if (typeof criticData.passed === 'number' && typeof criticData.total === 'number') {
                metaItems.push(`Checklist: ${criticData.passed}/${criticData.total}`);
            }
            metaItems.push('Re-orchestrating...');
            meta.innerHTML = metaItems.map(m => `<span>${escapeHtml(m)}</span>`).join('');

            toast.classList.add('active');
            clearTimeout(window.__criticToastTimer);
            window.__criticToastTimer = setTimeout(() => toast.classList.remove('active'), 6500);
        }

        function renderSteps(steps, currentStage) {
            const container = document.getElementById('steps-container');

            // Special state for Orchestration (Stage 1) waiting
            if ((!steps || steps.length === 0) && currentStage === 1) {
                container.innerHTML = `
                    <div class="radar-spinner">
                        <div class="radar-ripple"></div>
                        <div class="radar-ripple"></div>
                        <div class="radar-core"></div>
                    </div>
                    <div class="waiting-status">Orchestrator creating execution plan...</div>
                `;
                return;
            }

            // Generate Steps HTML
            let html = `
                <div class="step ${currentStage > 0 ? 'complete' : (currentStage === 0 ? 'active' : '')}" id="step-0-0">
                    <div class="step-marker">
                        <div class="step-circle"></div>
                        <div class="step-rail"></div>
                    </div>
                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-tool"><i class="fas fa-power-off"></i> Initialization</div>
                            <div class="step-meta">Step 0</div>
                        </div>
                        <div class="step-desc">Pipeline initialization, data loading, and agent setup.</div>
                    </div>
                </div>
            `;

            if (steps && steps.length > 0) {
                steps.forEach((step, index) => {
                    // Check for iteration change to inject separator
                    if (index > 0 && step.iteration > steps[index - 1].iteration) {
                        html += `
                            <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.8rem; opacity:0.7;">
                                <i class="fas fa-sync-alt"></i> RE-ORCHESTRATING (Iteration ${step.iteration})
                                <div style="height:1px; background:var(--border); margin:0.5rem 0;"></div>
                            </div>
                         `;
                    }

                    // Use unique ID prefix
                    const uid = step.iteration ? `${step.iteration}-${step.id}` : step.id;

                    html += `
                        <div class="step ${step.status} ${step.status === 'running' ? 'active' : ''}" id="step-${uid}">
                            <div class="step-marker">
                                <div class="step-circle"></div>
                                <div class="step-rail"></div>
                            </div>
                            <div class="step-card">
                                <div class="step-header">
                                    <div class="step-tool"><i class="fas fa-wrench"></i> ${step.tool}</div>
                                    <div class="step-meta">${step.duration ? (step.duration + 's')
                            : (step.status === 'running' ? 'running'
                                : (step.status === 'failed' ? 'failed'
                                    : (step.status === 'complete' ? 'complete' : 'pending')))
                        }</div>
                                </div>
                                <div class="step-desc">${step.desc}</div>
                                ${step.preview ? `<div class="step-preview">${step.preview}</div>` : ''}
                                ${step.error ? `<div class="step-preview" style="border-color:var(--danger); color:#fca5a5;">${step.error}</div>` : ''}
                            </div>
                </div>
                    `;
                });

                // If re-orchestrating (Stage 1) but we have history, show a spinner at the bottom
                if (currentStage === 1) {
                    html += `
                       <div class="step active" id="orchestrating-spinner" style="opacity:0.8;">
                           <div class="step-marker">
                               <div class="step-circle" style="background:var(--primary); animation:pulse 1.5s infinite;"></div>
                               <div class="step-rail"></div>
                           </div>
                           <div class="step-card" style="border:1px dashed #444; background:rgba(20,20,25,0.5);">
                               <div class="step-header">
                                   <div class="step-tool" style="color:var(--primary);">Orchestrating Next Phase...</div>
                               </div>
                               <div class="step-desc">Analyzing feedback and generating new execution plan.</div>
                           </div>
                       </div>
                    `;
                }
            }
            container.innerHTML = html;
        }

        function renderPlan(plans, currentRunningIter) {
            const listContainer = document.getElementById('plan-iter-list');
            const detailContainer = document.getElementById('plan-detail-view');

            if (!plans || Object.keys(plans).length === 0) {
                detailContainer.innerHTML = '<div style="text-align:center; color:#555; margin-top:3rem;">No plan generated yet.</div>';
                return;
            }

            // Determine which iteration to show: User selection OR current running
            const iterToShow = uiSelectedPlanIter || currentRunningIter || Object.keys(plans)[0];

            // Render Tabs
            listContainer.innerHTML = Object.keys(plans).map(iter => `
                <div class="file-item ${iter == iterToShow ? 'active' : ''}" style="padding:10px 16px; cursor:pointer;" onclick="uiSelectedPlanIter='${iter}'; renderPlan(window.lastPlans, ${currentRunningIter})">
                    <span><i class="fas fa-project-diagram"></i> Iteration ${iter}</span>
                </div>
            `).join('');

            // Render Current Plan
            const plan = plans[iterToShow];
            if (plan) {
                const steps = plan.steps || [];

                // PLAN SUMMARY HEADER
                const userExpl = plan.user_facing_explanation || plan.fusion_strategy || "No summary provided.";

                const stepsHtml = steps.map(s => {
                    // Visual dependency indicator
                    const depNodes = (s.depends_on || []).map(d =>
                        `<span style="background:#333; padding:2px 6px; border-radius:4px; font-size:0.65rem; margin-right:4px;">step_${d}</span>`
                    ).join('');

                    return `
                    <div class="plan-node" style="background:#0e0e0e; border:1px solid #333; padding:12px; border-radius:6px; margin-bottom:10px; border-left: 3px solid var(--primary);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px; align-items:center;">
                             <span style="font-weight:700; color:#fff; font-size:0.95rem;">${s.step_id}. ${s.tool_name}</span>
                             <span style="font-size:0.75rem; color:#666; background:#111; padding:2px 6px; border-radius:4px;">${s.estimated_tokens} tokens</span>
                        </div>
                        <div style="color:#ccc; font-size:0.85rem; line-height:1.4; margin-bottom:8px;">${s.description}</div>
                        
                        <!-- Dependencies -->
                        <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:6px;">
                            ${depNodes ? depNodes : ''}
                        </div>
                        
                        <!-- Reasoning on new line to avoid overlap -->
                        ${s.reasoning ? `
                            <div style="margin-top:6px; padding-top:6px; border-top:1px solid #222; font-size:0.75rem; color:#666; font-style:italic;">
                                <i class="fas fa-lightbulb" style="margin-right:4px;"></i> ${s.reasoning}
                            </div>
                        ` : ''}
                    </div>
                 `}).join('');

                detailContainer.innerHTML = `
                    <div style="margin-bottom:1.5rem; background:#1f1f23; padding:1.5rem; border-radius:8px; border:1px solid #333;">
                        <div style="color:var(--primary); font-size:0.8rem; letter-spacing:1px; font-weight:700; margin-bottom:0.5rem;">EXECUTION STRATEGY</div>
                        <div style="font-size:1rem; color:#eee; line-height:1.6;">${userExpl}</div>
                        <div style="margin-top:1rem; display:flex; gap:15px; font-size:0.8rem; color:#888;">
                             <span><i class="fas fa-fingerprint"></i> Plan ID: ${plan.plan_id || 'N/A'}</span>
                             <span><i class="fas fa-layer-group"></i> ${steps.length} Steps</span>
                        </div>
                    </div>
                    <div class="plan-timeline">
                        ${stepsHtml}
                    </div>
                 `;
            } else {
                detailContainer.innerHTML = '<div style="text-align:center; color:#555; margin-top:3rem;">Plan data not available for this iteration.</div>';
            }
        }

        // POLLING LOOP
        async function updateLoop() {
            try {
                const res = await fetch(`/api/snapshot?since_id=${latestEventId}`);
                const data = await res.json();
                const state = data.state;
                window.__lastState = state;
                updateDeepReportUi(state);

                const currentDeep = (state.deep_report_status || 'idle').toLowerCase();
                if (deepReportStatusSeen !== 'completed' && currentDeep === 'completed') {
                    await loadResults();
                    await openDeepPhenotypeReport();
                }
                deepReportStatusSeen = currentDeep;

                // Reset client-side session flags when a new pipeline run starts.
                const sessionKey = `${state.participant_id || ''}|${state.start_time || ''}`;
                if (window.__sessionKey && sessionKey !== window.__sessionKey) {
                    startTime = null;
                    hasShownResultModal = false;
                    currentIteration = state.iteration || 1;
                }
                window.__sessionKey = sessionKey;

                // Store plans globally for the click handler
                window.lastPlans = state.plans;

                // Stats
                document.getElementById('token-display').textContent = state.total_tokens.toLocaleString();
                document.getElementById('iter-display').textContent = state.iteration || 1;

                // Timer
                if (state.start_time && !startTime) startTime = new Date();
                if (startTime && !state.completed && state.status !== "Pipeline Completed") {
                    const diff = Math.floor((new Date() - startTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${m}:${s}`;
                }

                // Global Progress & Completion Check
                const maxIters = state.max_iterations || 1;
                const iterNow = state.iteration || 1;
                const criticIter = state.critic && state.critic.iteration ? state.critic.iteration : null;
                const isFinalCritic = state.critic && (
                    state.critic.verdict === 'SATISFACTORY' ||
                    (criticIter !== null ? criticIter >= maxIters : false)
                );

                if (state.completed || state.status === "Pipeline Completed" || state.status.includes("Run Complete") || isFinalCritic) {
                    if (isRunning) {
                        isRunning = false;
                        document.getElementById('session-status').textContent = "Run Complete";
                        document.getElementById('status-dot').classList.remove('pulse');
                        document.getElementById('global-progress').style.width = '100%';
                    }
                } else {
                    const pct = (state.progress / (state.max_steps || 1)) * 100;
                    document.getElementById('global-progress').style.width = `${Math.min(pct, 100)}%`;
                }

                // Stepper Header
                const stepper = document.getElementById('stepper');
                const curStage = state.current_stage || 0;
                if (state.stages) {
                    stepper.innerHTML = state.stages.map((st, i) => `
                        <div class="stepper-item ${i < curStage ? 'completed' : ''} ${i === curStage ? 'active' : ''}">
                            <div class="stepper-dot"></div>${st}
                        </div>
                        ${i < state.stages.length - 1 ? '<div class="stepper-line"></div>' : ''}
                    `).join('');
                }

                // Render Steps (Main Timeline) - WITH HISTORY
                const allSteps = (state.history || []).concat(state.steps);
                renderSteps(allSteps, state.current_stage);

                // Render Execution Plan tab
                if (state.plans) {
                    renderPlan(state.plans, state.iteration);
                }

                // Prediction + Critic Summary Panel
                if (state.prediction || state.critic) {
                    document.getElementById('prediction-hero').style.display = 'block';
                } else {
                    document.getElementById('prediction-hero').style.display = 'none';
                    document.getElementById('prediction-label').textContent = '--';
                    document.getElementById('prediction-prob').textContent = '--';
                    document.getElementById('prediction-conf').textContent = '--';
                    document.getElementById('critic-verdict').textContent = '--';
                    document.getElementById('critic-summary').textContent = 'Awaiting critic evaluation...';
                    document.getElementById('critic-checklist').innerHTML = '';
                    const fallbackEl = document.getElementById('critic-fallback');
                    if (fallbackEl) {
                        fallbackEl.innerHTML = '';
                        fallbackEl.style.display = 'none';
                    }
                }

                if (state.prediction) {
                    const label = state.prediction.label || normalizeClassification(state.prediction.result);
                    document.getElementById('prediction-label').textContent = label;
                    document.getElementById('prediction-prob').textContent = (state.prediction.prob * 100).toFixed(1) + "%";
                    document.getElementById('prediction-conf').textContent = state.prediction.confidence || '--';
                    document.getElementById('prediction-label').style.color = label === 'CASE' ? 'var(--case)' : (label === 'CONTROL' ? 'var(--control)' : 'var(--text-main)');
                }

                if (state.critic) {
                    const verdict = state.critic.verdict || '--';
                    document.getElementById('critic-verdict').textContent = verdict;
                    document.getElementById('critic-verdict').style.color = verdict === 'SATISFACTORY' ? 'var(--verdict_ok)' : 'var(--verdict_bad)';
                    document.getElementById('critic-summary').textContent = state.critic.summary || 'No critic summary provided.';
                    document.getElementById('critic-checklist').innerHTML = buildChecklistPills(state.critic.checklist, true);
                    const fallbackEl = document.getElementById('critic-fallback');
                    if (fallbackEl) {
                        if (state.critic.fallback_used) {
                            fallbackEl.innerHTML = formatFallbackMessage(state.critic);
                            fallbackEl.style.display = 'block';
                        } else {
                            fallbackEl.innerHTML = '';
                            fallbackEl.style.display = 'none';
                        }
                    }

                    const verdictBadge = document.getElementById('final-verdict');
                    verdictBadge.textContent = verdict;
                    verdictBadge.classList.remove('good', 'bad');
                    verdictBadge.classList.add(verdict === 'SATISFACTORY' ? 'good' : 'bad');

                    const statusDot = document.getElementById('status-dot');
                    statusDot.style.color = verdict === 'SATISFACTORY' ? 'var(--verdict_ok)' : 'var(--verdict_bad)';
                } else if (state.prediction) {
                    const label = state.prediction.label || normalizeClassification(state.prediction.result);
                    document.getElementById('status-dot').style.color = label === 'CASE' ? 'var(--case)' : (label === 'CONTROL' ? 'var(--control)' : 'var(--text-main)');
                }

                // Reset modal flag if iteration changes
                if (state.iteration && state.iteration > currentIteration) {
                    currentIteration = state.iteration;
                    hasShownResultModal = false;
                }

                // Result Modal (Run Summary)
                // Trigger when critic verdict is FINAL (SATISFACTORY or last iteration reached).
                if (state.critic && !hasShownResultModal && isFinalCritic) {
                    hasShownResultModal = true;
                    const summary = state.critic.summary || state.critic_summary || 'No critic summary provided.';
                    document.getElementById('final-summary').textContent = summary;
                    document.getElementById('final-probability').textContent = state.completion && state.completion.probability !== undefined
                        ? (state.completion.probability * 100).toFixed(1) + "%"
                        : (state.prediction ? (state.prediction.prob * 100).toFixed(1) + "%" : "--");
                    document.getElementById('final-iterations').textContent = state.completion && state.completion.iterations
                        ? state.completion.iterations
                        : (state.iteration || '--');
                    document.getElementById('final-checklist').innerHTML = buildChecklistPills(state.critic.checklist, false);

                    const resultPanel = document.getElementById('result-panel');
                    const resultIcon = document.getElementById('result-icon');
                    const summaryPanel = document.getElementById('final-summary');
                    if (state.critic.verdict === 'SATISFACTORY') {
                        resultPanel.style.borderColor = 'var(--verdict_ok)';
                        resultIcon.className = 'fas fa-check-circle';
                        resultIcon.style.color = 'var(--verdict_ok)';
                        summaryPanel.style.borderLeftColor = 'var(--verdict_ok)';
                    } else {
                        resultPanel.style.borderColor = 'var(--verdict_bad)';
                        resultIcon.className = 'fas fa-triangle-exclamation';
                        resultIcon.style.color = 'var(--verdict_bad)';
                        summaryPanel.style.borderLeftColor = 'var(--verdict_bad)';
                    }

                    document.getElementById('result-modal').classList.add('active');
                    document.getElementById('session-status').textContent = "Run Complete";
                    document.getElementById('status-dot').classList.remove('pulse');
                    isRunning = false;
                }

                if (state.status === "Pipeline Completed") {
                    isRunning = false;
                    document.getElementById('status-dot').classList.remove('pulse');
                }

                // Logs
                if (data.events.length > 0) {
                    const logCon = document.getElementById('log-container');
                    document.getElementById('activity-spinner').style.opacity = 1;
                    setTimeout(() => document.getElementById('activity-spinner').style.opacity = 0, 500);

                    data.events.forEach(e => {
                        if (e.id <= latestEventId) return;
                        latestEventId = e.id;
                        const div = document.createElement('div');
                        div.className = 'log-entry';
                        div.innerHTML = `<span class="log-ts">${e.time}</span><span class="log-type type-${e.type}">${e.type}</span> <span>${JSON.stringify(e.data).substring(0, 100)}</span>`;
                        logCon.appendChild(div);

                        if (e.type === 'CRITIC' && e.data && e.data.verdict === 'UNSATISFACTORY') {
                            const finalIter = e.data.iteration !== undefined && e.data.iteration !== null
                                ? e.data.iteration
                                : (state.iteration || 1);
                            const isFinal = finalIter >= (state.max_iterations || 1);
                            if (isFinal) {
                                showCriticToast(e.data);
                            }
                        }
                    });
                    if (autoScrollLogs) logCon.scrollTop = logCon.scrollHeight;
                }

                // Auto scroll main timeline
                if (isRunning && autoScrollTimeline && state.steps.length > 0) {
                    // Only scroll if timeline tab is active
                    if (document.getElementById('tab-timeline').classList.contains('active')) {
                        const activeStep = document.querySelector('.step.active');
                        if (activeStep) {
                            activeStep.scrollIntoView({ behavior: "smooth", block: "nearest" });
                        }
                    }
                }

            } catch (err) { console.error(err); }
        }

        async function loadResults() {
            try {
                // Get participant ID from state or input
                // It is safer to ask API for output directory content
                const res = await fetch('/api/outputs');
                const files = await res.json();

                const container = document.getElementById('file-list-container');
                if (files.length === 0) {
                    container.innerHTML = '<div style="color:#666">No output files found.</div>';
                    return;
                }

                container.innerHTML = files.map(f => `
                    <div class="file-item" data-file="${f}" onclick="loadFile('${f}', this)">
                        <span><i class="fas fa-file-code"></i> ${f}</span>
                        <i class="fas fa-chevron-right" style="font-size:0.7rem; opacity:0.5;"></i>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        async function loadFile(filename, el) {
            document.querySelectorAll('#file-list-container .file-item').forEach(el => el.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                const match = document.querySelector(`.file-item[data-file="${filename}"]`);
                if (match) match.classList.add('active');
            }

            const preview = document.getElementById('file-preview-container');
            preview.classList.remove('markdown-render');
            document.getElementById('current-file-name').textContent = filename;
            preview.textContent = "Loading...";

            const res = await fetch(`/api/outputs/content?file=${filename}`);
            const text = await res.text();

            if (filename.endsWith('.md') && window.marked && typeof window.marked.parse === 'function') {
                preview.classList.add('markdown-render');
                preview.innerHTML = window.marked.parse(normalizeMarkdownForRender(text));
            } else if (filename.endsWith('.md')) {
                preview.classList.add('markdown-render');
                preview.textContent = normalizeMarkdownForRender(text);
            } else {
                preview.textContent = text;
            }
        }

        function normalizeMarkdownForRender(text) {
            if (!text || typeof text !== 'string') return text;

            function isSeparatorCell(cell) {
                const trimmed = String(cell || '').trim();
                return /^:?-{3,}:?$/.test(trimmed);
            }

            function reflowInlineTable(tablePart) {
                let raw = String(tablePart || '').trim();
                if (!raw.startsWith('|')) raw = `|${raw}`;
                const parts = raw.split('|').map((p) => p.trim());
                if (parts.length && parts[0] === '') parts.shift();
                if (parts.length && parts[parts.length - 1] === '') parts.pop();

                let sepStart = -1;
                let sepCount = 0;
                for (let i = 0; i < parts.length; i += 1) {
                    if (isSeparatorCell(parts[i])) {
                        sepStart = i;
                        while (i + sepCount < parts.length && isSeparatorCell(parts[i + sepCount])) {
                            sepCount += 1;
                        }
                        break;
                    }
                }

                if (sepStart === -1 || sepCount === 0) {
                    const fallback = raw
                        .replace(/\|\s+\|/g, '|\n|')
                        .replace(/(?<!\n)\|---/g, '\n|---');
                    return fallback.split('\n');
                }

                const colCount = sepCount;
                const headerStart = Math.max(0, sepStart - colCount);
                const headerCells = parts.slice(headerStart, sepStart);
                const sepCells = parts.slice(sepStart, sepStart + colCount);
                const bodyCells = parts.slice(sepStart + colCount);

                const lines = [];
                lines.push(`| ${headerCells.join(' | ')} |`);
                lines.push(`|${sepCells.map((c) => c.replace(/[^-:]/g, '-')).join('|')}|`);
                for (let i = 0; i < bodyCells.length; i += colCount) {
                    const row = bodyCells.slice(i, i + colCount);
                    if (!row.length) break;
                    lines.push(`| ${row.join(' | ')} |`);
                }
                return lines;
            }

            const lines = text.split('\n');
            const normalized = [];

            for (const rawLine of lines) {
                const line = String(rawLine || '');
                if (line.includes('Table:') && line.includes('|') && line.split('|').length > 3) {
                    const idx = line.indexOf('Table:');
                    const titleAndMaybeFirstCell = line.slice(idx).trim();
                    const firstPipe = titleAndMaybeFirstCell.indexOf('|');
                    if (firstPipe > 0) {
                        const title = titleAndMaybeFirstCell.slice(0, firstPipe).trim();
                        const tablePart = titleAndMaybeFirstCell.slice(firstPipe).trim();
                        normalized.push(title);
                        normalized.push('');
                        const tableLines = reflowInlineTable(tablePart);
                        normalized.push(...tableLines);
                        normalized.push('');
                        continue;
                    }
                }
                normalized.push(line);
            }

            return normalized.join('\n');
        }

        async function openStandardReport() {
            try {
                const state = window.__lastState || {};
                const pid = state.participant_id || '';
                if (!pid) return;
                const targetName = `report_${pid}.md`;
                const res = await fetch('/api/outputs');
                const files = await res.json();
                const file = files.find(f => f === targetName) || files.find(f => f.startsWith(`report_${pid}`) && f.endsWith('.md'));
                if (file) {
                    await loadFile(file);
                }
            } catch (e) { console.error(e); }
        }

        async function openDeepPhenotypeReport() {
            try {
                const res = await fetch('/api/outputs');
                const files = await res.json();
                const file = files.find(f => f === 'deep_phenotype.md');
                if (file) {
                    await loadFile(file);
                }
            } catch (e) { console.error(e); }
        }

        async function loadInputs() {
            try {
                const res = await fetch('/api/inputs');
                const files = await res.json();

                const container = document.getElementById('input-list-container');
                if (files.length === 0) {
                    container.innerHTML = '<div style="padding:1rem; color:#666">No input files found.</div>';
                    return;
                }

                container.innerHTML = files.map(f => `
                    <div class="file-item" data-file="${f}" onclick="loadInputFile('${f}', this)">
                        <span><i class="fas fa-table"></i> ${f}</span>
                        <i class="fas fa-chevron-right" style="font-size:0.7rem; opacity:0.5;"></i>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        async function loadInputFile(filename, el) {
            document.querySelectorAll('#input-list-container .file-item').forEach(el => el.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                const match = document.querySelector(`#input-list-container .file-item[data-file="${filename}"]`);
                if (match) match.classList.add('active');
            }

            document.getElementById('current-input-name').textContent = filename;
            document.getElementById('input-preview-container').textContent = "Loading...";

            const res = await fetch(`/api/inputs/content?file=${filename}`);
            const text = await res.text();
            document.getElementById('input-preview-container').textContent = text;
        }

        setInterval(updateLoop, 800);
    </script>
</body>

</html>
