(function (global) {
  function escapeHtml(text) {
    return String(text || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function inlineParse(text) {
    var parts = String(text || "").split("`");
    var out = "";
    for (var i = 0; i < parts.length; i++) {
      if (i % 2 === 1) {
        out += "<code>" + escapeHtml(parts[i]) + "</code>";
      } else {
        var t = escapeHtml(parts[i]);
        t = t.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        t = t.replace(/\*(.+?)\*/g, "<em>$1</em>");
        t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        out += t;
      }
    }
    return out;
  }

  function isTableSeparator(line) {
    return /^\s*\|?\s*:?-{3,}:?\s*(\|\s*:?-{3,}:?\s*)+\|?\s*$/.test(line || "");
  }

  function splitRow(line) {
    var trimmed = String(line || "").trim();
    if (trimmed.startsWith("|")) trimmed = trimmed.slice(1);
    if (trimmed.endsWith("|")) trimmed = trimmed.slice(0, -1);
    return trimmed.split("|").map(function (cell) {
      return cell.trim();
    });
  }

  function startsSpecial(line) {
    return (
      /^\s*#{1,6}\s+/.test(line) ||
      /^\s*[-*]\s+/.test(line) ||
      /^\s*\d+\.\s+/.test(line) ||
      /^\s*```/.test(line)
    );
  }

  function parse(md) {
    var lines = String(md || "").replace(/\r\n/g, "\n").split("\n");
    var html = "";
    var i = 0;

    while (i < lines.length) {
      var line = lines[i];

      if (/^\s*```/.test(line)) {
        var fence = line.trim();
        var codeLines = [];
        i++;
        while (i < lines.length && lines[i].trim() !== fence) {
          codeLines.push(lines[i]);
          i++;
        }
        i++;
        html += "<pre><code>" + escapeHtml(codeLines.join("\n")) + "</code></pre>";
        continue;
      }

      if (line.indexOf("|") !== -1 && isTableSeparator(lines[i + 1])) {
        var headerCells = splitRow(line);
        i += 2;
        var bodyRows = [];
        while (i < lines.length && lines[i].trim() !== "" && lines[i].indexOf("|") !== -1) {
          bodyRows.push(splitRow(lines[i]));
          i++;
        }
        html += "<table><thead><tr>";
        for (var h = 0; h < headerCells.length; h++) {
          html += "<th>" + inlineParse(headerCells[h]) + "</th>";
        }
        html += "</tr></thead><tbody>";
        for (var r = 0; r < bodyRows.length; r++) {
          html += "<tr>";
          for (var c = 0; c < bodyRows[r].length; c++) {
            html += "<td>" + inlineParse(bodyRows[r][c]) + "</td>";
          }
          html += "</tr>";
        }
        html += "</tbody></table>";
        continue;
      }

      var headingMatch = line.match(/^\s*(#{1,6})\s+(.*)$/);
      if (headingMatch) {
        var level = headingMatch[1].length;
        html += "<h" + level + ">" + inlineParse(headingMatch[2]) + "</h" + level + ">";
        i++;
        continue;
      }

      if (/^\s*[-*]\s+/.test(line)) {
        html += "<ul>";
        while (i < lines.length && /^\s*[-*]\s+/.test(lines[i])) {
          html += "<li>" + inlineParse(lines[i].replace(/^\s*[-*]\s+/, "")) + "</li>";
          i++;
        }
        html += "</ul>";
        continue;
      }

      if (/^\s*\d+\.\s+/.test(line)) {
        html += "<ol>";
        while (i < lines.length && /^\s*\d+\.\s+/.test(lines[i])) {
          html += "<li>" + inlineParse(lines[i].replace(/^\s*\d+\.\s+/, "")) + "</li>";
          i++;
        }
        html += "</ol>";
        continue;
      }

      if (line.trim() === "") {
        i++;
        continue;
      }

      var para = [];
      while (i < lines.length && lines[i].trim() !== "" && !startsSpecial(lines[i])) {
        para.push(lines[i]);
        i++;
      }
      html += "<p>" + inlineParse(para.join(" ")) + "</p>";
    }

    return html;
  }

  global.marked = { parse: parse };
})(typeof window !== "undefined" ? window : this);
